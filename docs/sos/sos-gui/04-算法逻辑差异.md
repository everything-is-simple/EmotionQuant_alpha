# 04 算法逻辑差异

**对比来源**: gui-algorithm.md v3.2.0 vs src/gui/formatter.py + src/gui/data_service.py

---

## 一、指标分级算法（已正确实现）

### §2.1 温度颜色分级 ✅
```
设计: >80 red/high, >=45 orange/medium, >=30 cyan/cool, <30 blue/low
代码: formatter.py:26-33 — 完全一致
```

### §2.2 推荐等级分级 ✅
```
设计: >=75+cycle STRONG_BUY, >=70 BUY, >=50 HOLD, >=30 SELL, <30 AVOID
代码: recommendation_color() — 颜色映射正确（STRONG_BUY/BUY→red, HOLD→orange, SELL/AVOID→gray）
注意: 代码中 recommendation_color 不执行评分→等级的计算，仅做等级→颜色映射。
      评分→等级计算应在 Integration 层完成，GUI 只负责展示——符合"只读展示"铁律。
```

### §2.3 轮动状态分级 ✅
```
设计: IN→highlight, HOLD→normal, OUT→muted
代码: rotation_status_color() — IN→green, HOLD→orange, OUT→gray — 映射正确
```

### §2.4 机会等级分级 ✅
```
设计: S→gold, A→green, B→blue, C→gray, D→red
代码: opportunity_level_color() — 完全一致
```

### §2.5 周期中英文映射 ✅
```
设计: emergence→萌芽期/blue, fermentation→发酵期/cyan, ...
代码: CYCLE_MAP — 8 个周期映射完全一致
```

### §2.6 趋势图标映射 ✅
```
设计: up→(↑, red), down→(↓, green), sideways→(→, gray)
代码: format_trend() — A 股红涨绿跌，完全一致
```

### §2.7 盈亏颜色 ✅
```
设计: >0→red(盈利), <0→green(亏损), =0→gray(持平)
代码: pnl_color() — 完全一致
```

---

## 二、列表排序算法（部分缺失）

### §3.1 默认排序规则

| 页面 | 设计要求 | 代码实现 | 状态 |
|------|----------|----------|------|
| Dashboard推荐 | final_score DESC, stock_code ASC | `ORDER BY final_score DESC LIMIT ?` | ⚠️ 缺少次排序 stock_code ASC |
| MSS历史 | trade_date DESC | `ORDER BY trade_date DESC` | ✅ |
| IRS行业 | rank ASC, industry_score DESC | `ORDER BY industry_score DESC` | ⚠️ 仅单字段 |
| PAS个股 | opportunity_score DESC, neutrality ASC | `ORDER BY opportunity_score DESC` | ⚠️ 缺少次排序 neutrality ASC |
| 集成推荐 | final_score DESC, position_size DESC | `ORDER BY final_score DESC` | ⚠️ 缺少次排序 |
| 交易记录 | trade_date DESC, trade_id DESC | `ORDER BY trade_id DESC` | ⚠️ 缺少 trade_date DESC |
| 持仓列表 | market_value DESC, unrealized_pnl DESC | `ORDER BY market_value DESC` | ⚠️ 缺少次排序 |

**诊断**: 所有页面都只实现了主排序字段，次排序字段均未实现。

**急救方案**: 在各 SQL 中补齐 ORDER BY 子句的次排序字段。

### §3.2 多字段排序函数 — 未实现

设计中的 `multi_sort(items, sort_fields, directions)` 函数未在代码中实现。代码直接在 SQL 中排序（但不完整）。

---

## 三、过滤算法（核心未实现）

### §4.1 默认过滤条件 — ❌ 全部未实现 ★★★

| 页面 | 设计要求的过滤 | 代码实现 |
|------|----------------|----------|
| Dashboard | final_score >= dashboard_min_score | ❌ 无过滤 |
| IRS | rank <= irs_max_rank, rotation_status IN irs_rotation_status | ❌ 无过滤 |
| PAS | opportunity_score >= pas_min_score, grade >= pas_min_level | ❌ 无过滤 |
| 集成推荐 | final_score >= integrated_min_score, position >= integrated_min_position | ❌ 无过滤 |

**这是最严重的功能性缺失之一**: 用户看到的数据完全未经过滤，包括低分、低仓位的推荐也会展示。

### §4.2 过滤链算法 — 未实现

设计中的 `apply_filters(items, filters)` 链式过滤函数未在代码中实现。

### §4.3 过滤阈值可视化 — 部分实现

`build_filter_preset_badges()` 在 formatter.py 中实现了徽标文本生成，但由于实际过滤未执行，这些徽标是"虚假承诺"——显示"final_score >= 60"但实际不过滤。

---

## 四、分页算法（基本实现）

### §5.2 分页计算 ✅

data_service.py 中的 `_paginate()` + 手动分片逻辑与设计一致：
```python
total_pages = max(1, (total + page_size - 1) // page_size)
# start/end 计算、has_prev/has_next 逻辑均正确
```

---

## 五、缓存策略（完全未实现）

### §6.1 缓存时间规则 — ❌ 未实现

设计定义了 4 类 TTL（24h/1min/24h/会话级），代码中有 `_FRESHNESS_TTL` 字典定义了这些值，但由于无缓存机制，这些值从未被使用。

### §6.2 缓存键生成 — ❌ 未实现

### §6.3 缓存失效 — ❌ 未实现

### §6.4 新鲜度分级 — 实现但无效

`_build_freshness()` 函数的分级逻辑正确（0.5*TTL / TTL 分界），但 data_asof 总是当前时间，导致 age_sec ≈ 0，永远返回 "fresh"。

---

## 六、图表数据转换（部分实现）

### §7.1 温度曲线 — ⚠️ 缺失 zones

代码构建了 x_axis + y_axis，但设计要求的 4 色 zones 完全未实现。温度曲线缺少背景色域划分。

### §7.2 行业排名柱状图 — ⚠️ 颜色逻辑偏差

**设计**: `"green" if rotation_status == "IN" else "gray"` (二色)
**代码**: 使用 `status_color`，产生 green/orange/gray (三色)
- IN → green ✅
- HOLD → orange（设计要求 gray）⚠️
- OUT → gray ✅

**急救方案**: 决定是否接受三色方案（代码更丰富），如果要严格对齐则改为设计的二色方案

### §7.3 推荐散点图 — ❌ 完全未实现

设计中的 `transform_recommendation_scatter()` 在代码中不存在，Dashboard 中也没有散点图渲染。

---

## 七、导出算法（路径体系不同）

### §8.1 CSV 导出 — ❌ 未实现（设计路径: .reports/gui/）
### §8.2 Markdown 导出 — ⚠️ 不同实现

app.py 中有 Markdown 文件写入，但路径为 `artifacts/spiral-s5/{date}/`，非设计中的 `.reports/gui/`。

---

## 八、可观测性（完全未实现）

### §9.1 异常可观测性计数 — ❌ 未实现
### §9.2 推荐原因联动面板 — ❌ 未实现

---

## 急救方案优先级总结

| 算法模块 | 优先级 | 差异程度 |
|----------|--------|----------|
| 默认过滤条件生效 | P0 | 完全未实现 |
| 次排序字段补齐 | P1 | 主排序OK，次排序缺失 |
| 温度曲线 zones | P1 | 数据准备逻辑缺失 |
| 推荐散点图 | P2 | 整体缺失 |
| 缓存机制 | P0 | 整体缺失 |
| 新鲜度真实化 | P0 | 伪造 data_asof |
| IRS 图表颜色 | P3 | 三色 vs 二色的设计分歧 |
| 可观测性 | P2 | 整体缺失 |
| 导出功能 | P1 | 路径体系不同 |
