# SOS 急救方案总览 — GUI 代码与核心设计差异全景

**检查日期**: 2026-02-27
**检查范围**:
- 设计文档: `docs/design/core-infrastructure/gui/` (4份, v3.2.0)
- 代码文件: `src/gui/` (app.py, dashboard.py, data_service.py, formatter.py, models.py)
- 关联代码: `src/backtest/pipeline.py` (回测与 GUI Analysis 页面的数据对接)

---

## 差异严重度分级

| 级别 | 含义 | 数量 |
|------|------|------|
| P0-致命 | 设计核心概念在代码中完全缺失或根本性偏离 | 7 项 |
| P1-严重 | 设计明确定义的模型/接口在代码中缺失 | 9 项 |
| P2-中等 | 设计有要求但代码实现有偏差或不完整 | 6 项 |
| P3-轻微 | 命名/组织方式的偏差，不影响功能正确性 | 3 项 |

---

## P0-致命差异（7项）

### P0-1 ★ 模块结构完全不同
- **设计**: 4 层目录 `pages/ + components/ + services/ + utils/`，约 18 个文件
- **代码**: 扁平结构 5 个文件，无子目录
- **影响**: 所有设计文档的模块引用路径均无法对应代码
- **详见**: `01-模块结构差异.md`

### P0-2 ★ DataService 构造方式根本不同
- **设计**: `DataService(repository: DataRepository)` — 通过仓库抽象层访问数据
- **代码**: `DataService(database_path: Path)` — 直接操作 DuckDB 裸 SQL
- **影响**: 设计中的 DataRepository 抽象层完全不存在
- **详见**: `03-API接口差异.md`

### P0-3 ★ GuiRunResult 定义完全不同
- **设计**: `GuiRunResult(rendered_pages, data_state, freshness_summary, created_at)` — GUI 渲染结果
- **代码**: `GuiRunResult(export_mode, artifacts_dir, daily_report_path, quality_status, go_nogo, ...)` — 导出产物结果
- **影响**: 两者描述的是完全不同的概念，设计中的最小闭环无法落地
- **详见**: `02-数据模型差异.md`

### P0-4 ★ 缺失 CacheService 整层
- **设计**: 独立 CacheService 含 `get_cached/set_cached/build_cache_key/get_freshness_meta`
- **代码**: 无任何缓存机制，DataService 每次直接查库
- **影响**: 高频访问时性能问题；新鲜度机制名存实亡（代码中的 FreshnessMeta 用 now() 填充，非真实缓存年龄）
- **详见**: `03-API接口差异.md`

### P0-5 ★ 缺失 FilterService 整层
- **设计**: 独立 FilterService 含 `apply_filters/apply_sort/paginate/resolve_filter_config`
- **代码**: FilterConfig 参数被接受但从未真正用于数据过滤！DataService 查询不附加任何过滤条件
- **影响**: 用户看到的是全量未过滤数据，与设计中的"默认过滤条件"完全不符
- **详见**: `03-API接口差异.md`

### P0-6 ★ 缺失 ExportService 整层
- **设计**: ExportService 含 CSV/Markdown 导出、推荐列表导出、绩效报告导出
- **代码**: 无 ExportService，app.py 的导出逻辑是生成 artifact 文件（非设计中的按需导出）
- **详见**: `03-API接口差异.md`

### P0-7 ★ 缺失 run_minimal 最小闭环入口
- **设计**: `DataService.run_minimal(trade_date) → GuiRunResult` (CP-09 闭环契约)
- **代码**: 不存在此方法，无法满足 CP-09
- **详见**: `03-API接口差异.md`

---

## P1-严重差异（9项）

### P1-1 缺失 UiObservabilityPanel 模型
- **设计**: `UiObservabilityPanel(timeout_count_1h, empty_state_count_1h, ...)` 在 IntegratedPageData 中使用
- **代码**: 模型未定义，IntegratedPageData 缺少 observability 字段

### P1-2 缺失 RecommendationReasonPanel 模型及联动逻辑
- **设计**: 推荐原因面板含 mss/irs/pas_attribution + risk_alert + deviation_hint
- **代码**: 模型未定义，无联动逻辑

### P1-3 RecommendationItem 缺失 reason_panel 字段
- **设计**: `reason_panel: RecommendationReasonPanel = None`
- **代码**: 无此字段

### P1-4 TemperatureChartData 缺失 zones 字段
- **设计**: `zones: List[ChartZone]` — 含 4 个温度区域的颜色/标签/边界
- **代码**: 仅有 x_axis + y_axis，无 zones

### P1-5 缺失 ChartZone 模型
- **设计**: `ChartZone(min_value, max_value, include_min, include_max, color, label)`
- **代码**: 未定义

### P1-6 缺失 RecommendationScatterData / ScatterPoint 模型
- **设计**: 推荐散点图数据结构
- **代码**: 未定义

### P1-7 缺失 GuiConfig 模型
- **设计**: `GuiConfig(refresh_interval, default_page_size, top_n_recommendations, ...)`
- **代码**: 硬编码在各处（top_n=10, page_size=50 等）

### P1-8 缺失 PermissionConfig 模型
- **设计**: `PermissionConfig(level, can_export, can_adjust_display)` — Viewer/Analyst/Admin
- **代码**: 无权限概念

### P1-9 缺失 ChartService 整层
- **设计**: `build_temperature_chart/build_industry_chart/build_recommendation_scatter`
- **代码**: 图表构建散落在 DataService 中，且功能不完整

---

## P2-中等差异（6项）

### P2-1 FilterConfig 参数被接受但未生效
- DataService 各方法签名含 `filters: FilterConfig` 参数，但查询 SQL 不使用任何阈值过滤
- `build_filter_preset_badges` 虽然构建了徽标文本，但对应的实际过滤逻辑缺失

### P2-2 IRS 图表颜色逻辑偏差
- **设计**: `"green" if rotation_status == "IN" else "gray"` (仅 green/gray 两色)
- **代码**: 使用 `status_color`，HOLD 映射为 `"orange"` (三色: green/orange/gray)

### P2-3 回测数据与 GUI 字段名不匹配
- GUI `_map_backtest` 读取 `backtest_name` → 回测写入的是 `backtest_id`（无 backtest_name 列）
- GUI 读取 `annual_return` → 回测不写此列（结果始终为 0）
- **详见**: `06-回测与GUI集成差异.md`

### P2-4 FreshnessMeta 名存实亡
- 代码用 `_utc_now()` 作为 `data_asof`，cache_age 永远为 0 或极小值
- 设计中的缓存新鲜度分级逻辑无法触发 stale_soon/stale 状态

### P2-5 缺失 record_ui_event 可观测性
- **设计**: logger + metrics 记录 UI 事件（timeout/empty_state/data_fallback）
- **代码**: 完全没有 UI 事件记录

### P2-6 Dashboard 未显示散点图
- **设计**: 信息流中包含推荐散点图组件
- **代码**: Dashboard 仅有 dataframe 表格展示

---

## P3-轻微差异（3项）

### P3-1 formatter.py vs formatters.py 命名
- **设计**: `utils/formatters.py`（复数）
- **代码**: `gui/formatter.py`（单数，且非 utils 子目录）

### P3-2 导出路径约定
- **设计**: `.reports/gui/{filename}_{timestamp}.csv`
- **代码**: `artifacts/spiral-s5/{trade_date}/` (不同的路径体系)

### P3-3 dashboard.py 双重用途
- **设计**: dashboard.py 仅为 Dashboard 页面
- **代码**: dashboard.py 是 Streamlit 主入口，含全部 7 个页面的渲染逻辑

---

## 详细分析文件索引

| 文件 | 内容 |
|------|------|
| `01-模块结构差异.md` | 设计目录结构 vs 代码实际结构，影响分析 |
| `02-数据模型差异.md` | gui-data-models.md 中定义的所有模型 vs models.py 中的实现 |
| `03-API接口差异.md` | gui-api.md 中定义的所有服务接口 vs 代码实现 |
| `04-算法逻辑差异.md` | gui-algorithm.md 中的算法 vs formatter.py/data_service.py 的实现 |
| `05-信息流差异.md` | gui-information-flow.md 中的数据流 vs 代码实际数据流 |
| `06-回测与GUI集成差异.md` | backtest/pipeline.py 输出 vs GUI Analysis 页面消费的字段映射 |
