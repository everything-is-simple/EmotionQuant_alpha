# 02 数据模型差异

**对比来源**: gui-data-models.md v3.2.0 vs src/gui/models.py + src/gui/app.py

---

## 一、完全缺失的模型（6个）

### 1. GuiRunResult — 设计定义 vs 代码定义冲突 ★★★

**设计** (gui-data-models.md §1.10):
```python
@dataclass
class GuiRunResult:
    trade_date: str
    rendered_pages: List[str]           # ["dashboard", "integrated"]
    data_state: str                     # ok/warn_data_fallback/partial_skipped
    freshness_summary: Dict[str, str]   # 页面 -> fresh/stale_soon/stale
    created_at: datetime
```

**代码** (app.py:37-49):
```python
@dataclass(frozen=True)
class GuiRunResult:
    trade_date: str
    export_mode: str
    artifacts_dir: Path
    daily_report_path: Path | None
    gui_export_manifest_path: Path | None
    gate_report_path: Path | None
    consumption_path: Path | None
    quality_status: str
    go_nogo: str
    dashboard_url: str | None
    has_error: bool
```

**诊断**: 同名不同义。设计的 GuiRunResult 是"GUI 渲染闭环结果"；代码的是"导出产物打包结果"。两者功能完全不同，且代码版本不在 models.py 中定义。

**急救方案**:
- 在 models.py 中新增设计版 GuiRunResult（可改名 GuiRenderResult 避免冲突）
- 代码 app.py 中的版本改名为 GuiExportResult
- 或者：修订设计文档，承认两种 Result 的并存

### 2. UiObservabilityPanel — 完全缺失

**设计** (gui-data-models.md §1.13):
```python
@dataclass
class UiObservabilityPanel:
    timeout_count_1h: int
    empty_state_count_1h: int
    data_fallback_count_1h: int
    permission_denied_count_1h: int
    last_error_message: str
```

**急救方案**: 在 models.py 中补齐此 dataclass；在 IntegratedPageData 中添加 observability 字段

### 3. RecommendationReasonPanel — 完全缺失

**设计** (gui-data-models.md §1.11):
```python
@dataclass
class RecommendationReasonPanel:
    stock_code: str
    trade_date: str
    mss_attribution: float
    irs_attribution: float
    pas_attribution: float
    risk_alert: str
    risk_turning_point: str
    deviation_hint: str           # signal/execution/cost
```

**急救方案**: 在 models.py 中补齐；但此模型依赖 Analysis L4 层数据（signal_attribution, live_backtest_deviation），需确认上游数据是否就绪

### 4. ChartZone — 完全缺失

**设计** (gui-data-models.md §2.1):
```python
@dataclass
class ChartZone:
    min_value: float
    max_value: float
    include_min: bool
    include_max: bool
    color: str
    label: str
```

**急救方案**: 在 models.py 中补齐

### 5. RecommendationScatterData + ScatterPoint — 完全缺失

**设计** (gui-data-models.md §2.3):
```python
@dataclass
class RecommendationScatterData:
    points: List[ScatterPoint]
    x_label: str
    y_label: str

@dataclass
class ScatterPoint:
    x: float
    y: float
    label: str
    color: str
```

**急救方案**: 在 models.py 中补齐

### 6. GuiConfig — 完全缺失

**设计** (gui-data-models.md §4.1):
```python
@dataclass
class GuiConfig:
    refresh_interval: int = 60
    default_page_size: int = 50
    top_n_recommendations: int = 10
    top_n_industries: int = 5
    mss_history_days: int = 60
    show_filter_badges: bool = True
    show_freshness_badge: bool = True
```

**代码**: 这些值全部硬编码在 data_service.py 和 dashboard.py 的各处

**急救方案**: 在 models.py 中补齐，替换硬编码

### 7. PermissionConfig — 完全缺失

**设计** (gui-data-models.md §4.3):
```python
@dataclass
class PermissionConfig:
    level: str = "Analyst"
    can_export: bool = True
    can_adjust_display: bool = False
```

**急救方案**: 按 P1 优先级在 models.py 中补齐（当前可不做强校验）

---

## 二、存在但字段有差异的模型（3个）

### 1. IntegratedPageData — 缺少 observability 字段

**设计**:
```python
class IntegratedPageData:
    trade_date: str
    recommendations: List[RecommendationItem]
    pagination: PaginationInfo
    data_asof: str
    freshness: FreshnessMeta
    active_filter_badges: List[str]
    observability: UiObservabilityPanel  # ← 缺失
```

**代码** (models.py:263-272): 缺少 `observability` 字段

### 2. RecommendationItem — 缺少 reason_panel 字段

**设计**:
```python
class RecommendationItem:
    ...（15个字段）
    reason_panel: RecommendationReasonPanel = None  # ← 缺失
```

**代码** (models.py:134-153): 只有 15 个字段，无 reason_panel

### 3. TemperatureChartData — 缺少 zones 字段

**设计**:
```python
class TemperatureChartData:
    x_axis: List[str]
    y_axis: List[float]
    zones: List[ChartZone]  # ← 缺失
```

**代码** (models.py:207-212): 只有 x_axis + y_axis

---

## 三、已正确实现的模型（供对照）

以下模型在 models.py 中的实现与设计一致（字段名、类型、默认值均匹配）：

- ✅ FreshnessMeta
- ✅ FilterConfig
- ✅ PaginationInfo
- ✅ TemperatureCardData
- ✅ CycleBadgeData
- ✅ IndustryRankItem
- ✅ StockPasDisplay
- ✅ MssPanoramaDisplay
- ✅ IndustryChartData
- ✅ IrsPageData
- ✅ PasPageData
- ✅ MssPageData
- ✅ PositionDisplay
- ✅ TradeRecordDisplay
- ✅ TradingPageData
- ✅ PerformanceMetricsDisplay
- ✅ BacktestSummaryDisplay
- ✅ AnalysisPageData
- ✅ DashboardData

---

## 四、枚举对照

| 枚举 | 设计 | 代码 | 状态 |
|------|------|------|------|
| FreshnessLevel | ✅ | ✅ | 一致 |
| TemperatureLevel | ✅ | ✅ | 一致 |
| RecommendationLevel | ✅ | ✅ | 一致 |
| OpportunityLevel | ✅ | ✅ | 一致 |
| RotationStatus | ✅ | ✅ | 一致 |

---

## 急救方案汇总

| 模型 | 优先级 | 动作 |
|------|--------|------|
| GuiRunResult | P0 | 代码与设计定义冲突，需决策如何并存 |
| UiObservabilityPanel | P1 | 补齐模型 + IntegratedPageData 字段 |
| RecommendationReasonPanel | P1 | 补齐模型 + RecommendationItem 字段 |
| ChartZone | P1 | 补齐模型 + TemperatureChartData.zones |
| RecommendationScatterData/ScatterPoint | P1 | 补齐模型 |
| GuiConfig | P1 | 补齐模型 + 替换硬编码 |
| PermissionConfig | P2 | 补齐模型（暂不做强校验） |
