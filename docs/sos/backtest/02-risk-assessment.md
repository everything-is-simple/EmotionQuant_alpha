# 02 — 风险评估（Backtest 篇）

每项差异从三个维度评估：**业务风险**（对回测结果可信度的影响）、**系统完整性**（对上下游链路的影响）、**债务膨胀**（放任不管的后果）。

---

## 风险矩阵总览

| GAP | 名称 | 业务风险 | 系统完整性 | 债务膨胀 | 综合 |
|-----|------|---------|-----------|---------|------|
| GAP-B01 | 卖出逻辑退化为次日清仓 | 🔴 极高 | 🔴 高 | 🔴 高 | **P0-紧急** |
| GAP-B02 | max_drawdown 公式错误 | 🔴 高 | 🔴 高 | 🟡 中 | **P0-紧急** |
| GAP-B03 | total_return 口径偏差 | 🔴 高 | 🔴 高 | 🟡 中 | **P0-紧急** |
| GAP-B04 | 信号过滤 4 层只实现 1 层 | 🔴 高 | 🟡 中 | 🔴 高 | **P0-紧急** |
| GAP-B05 | Gate 全局阻断非逐日 | 🔴 高 | 🟡 中 | 🟡 中 | **P0-紧急** |
| GAP-B06 | 仓位基数 cash 非 equity | 🟡 中 | 🟡 中 | 🟡 中 | **P0-紧急** |
| GAP-B07 | 核心绩效指标全缺 | 🟡 中 | 🔴 高 | 🔴 高 | **P1-高** |
| GAP-B08 | max_positions 约束缺失 | 🟡 中 | 🟡 中 | 🟡 中 | **P1-高** |
| GAP-B09 | 成交价无滑点 | 🟡 中 | 🟡 中 | 🟡 中 | **P1-高** |
| GAP-B10 | 模式 TD/BU 不区分 | 🟡 低 | 🔴 高 | 🟡 中 | **P1-高** |
| GAP-B11 | 成交概率模型不一致 | 🟡 低 | 🟡 中 | 🟡 中 | **P2-中** |
| GAP-B12 | 停牌处理缺失 | 🟡 低 | 🟡 中 | 🟡 中 | **P2-中** |
| GAP-B13 | 架构 OOP→单函数 | 🟢 无 | 🟡 中 | 🟡 中 | **P3-低** |
| GAP-B14 | dataclass 全缺 | 🟢 无 | 🟡 低 | 🟡 中 | **P3-低** |
| GAP-B15 | 枚举全缺 | 🟢 无 | 🟡 低 | 🟡 低 | **P3-低** |
| GAP-B16 | trade_records 表结构偏离 | 🟡 低 | 🟡 中 | 🟡 中 | **P2-中** |
| GAP-B17 | backtest_results 表结构偏离 | 🟡 低 | 🟡 中 | 🟡 中 | **P2-中** |
| GAP-B18 | 状态机缺失 | 🟢 无 | 🟡 中 | 🟡 中 | **P3-低** |
| GAP-B19 | 代码含设计未涉及概念 | 🟢 无 | 🟡 低 | 🟡 低 | **P3-低** |

---

## P0 — 紧急（回测结果不可信）

### GAP-B01: 卖出逻辑退化 → 回测完全失真

**业务风险**: 🔴 极高
- 设计的持仓策略是"止损/止盈/时限触发退出"，代码的行为是"T+1 解锁立即清仓"
- 所有回测绩效指标（收益率、回撤、胜率）都是基于"买入→次日卖"策略生成，与设计意图完全不同
- 这是**回测系统的核心逻辑**，错误意味着全部产出无效

**最坏场景**: 基于当前回测结果做出的任何策略判断（权重调整、风控参数、信号筛选门槛）都建立在错误的数据基础上。

**系统影响**: Analysis 层消费 backtest_results 做绩效评估和偏差归因，基于错误回测结果的分析同样无效。Trading 层如果参考回测胜率做决策，也会被误导。

---

### GAP-B02: max_drawdown 公式错误 → 风险指标不可信

**业务风险**: 🔴 高
- 最大回撤是风控核心指标，投资决策中的"红线"
- 代码公式在特定权益曲线形态下会高估回撤（把初始低点算进去），导致过度保守的风控判断
- `(max - min) / max` 不是行业标准的最大回撤定义

**系统影响**: Analysis 层的 max_drawdown（如果从 backtest_results 读取）也是错的。Calmar Ratio（= annual_return / max_drawdown）依赖此值。

---

### GAP-B03: total_return 口径偏差 → 收益率虚低

**业务风险**: 🔴 高
- 仅计算已实现盈亏，未计入期末持仓的浮动盈亏
- 在 GAP-B01 修复后（持仓不再次日清仓），回测结束时大概率有未平仓持仓，此口径偏差将显著放大
- 投资者看到的 total_return 会系统性偏低

**系统影响**: Analysis 层的 A/B metric 对比基于 total_return，口径偏差导致策略对比失真。

---

### GAP-B04: 信号过滤缺失 → 低质量信号入模

**业务风险**: 🔴 高
- `min_final_score` 未使用：低评分信号也会被交易
- `direction=neutral` 未过滤：中性信号（仅观望）也会生成买入
- `risk_reward_ratio<1.0` 误为全局阻断：本应逐信号跳过的条件变成了整个回测的阻断项。如果任何一条信号 RR<1，整个回测 FAIL

**连锁反应**: RR<1 的全局阻断意味着——只要 `integrated_recommendation` 中存在任何一条 RR<1 的记录（即使是 HOLD/SELL 级别），整个回测就会被阻断。这与设计意图严重相反。

---

### GAP-B05: Gate 全局阻断 → 过度保守

**业务风险**: 🔴 高
- 如果回测窗口内有某一天 Gate=FAIL（例如数据临时缺失），整个回测零交易
- 设计意图：那一天跳过，其余天正常运行
- 结果：回测的有效天数大幅减少，可能产出零交易的空结果

**系统影响**: 与 Validation 篇 Gate 输出口径相关。Validation 可能按日输出 PASS/WARN/FAIL，Backtest 应逐日消费。

---

### GAP-B06: 仓位基数 cash → 仓位分配不均

**业务风险**: 🟡 中
- 差异量级取决于持仓集中度。如果首批买入用掉 80% cash，后续标的仓位被极度压缩
- 但在 GAP-B01 当前的"次日清仓"行为下，持仓总是只有一天，影响被 GAP-B01 掩盖
- GAP-B01 修复后此问题才会真正显现

**修复时机**: 与 GAP-B01 同批修复（它们共同影响回放循环）。

---

## P1 — 高（功能完整性，影响跨模块）

### GAP-B07: 绩效指标全缺 → Analysis 层无法计算

**系统完整性**: 🔴 高
- 这是 **跨模块阻塞项**。Analysis 篇 GAP-A01 的根因之一。
- 即使 Analysis 实现了绩效计算逻辑，也需要 equity_curve 数据（未持久化→ Analysis 篇 GAP-A07）
- 双重断裂：指标未算 + 源数据未存

**短期可接受**: 如果当前 Analysis 层也只是硬编码 0.0（确实如此），两边"一致地错"。
**长期不可接受**: 任何依赖 Sharpe/Calmar/年化收益做决策的模块都会收到 0 或缺失。

---

### GAP-B08: max_positions 缺失 → 仓位不受控

**业务风险**: 🟡 中
- 理论上可以同时持有无限多标的，实际受 cash 限制
- 但 GAP-B01 当前的"次日清仓"使持仓永远 ≤ 1天，max_positions 约束未被触发
- GAP-B01 修复后此约束变得关键

---

### GAP-B09: 成交价无滑点 → 收益高估

**业务风险**: 🟡 中
- 买入用真实开盘价（偏低）、卖出用真实开盘价（偏高）——实际上滑点会让买入更贵、卖出更便宜
- 影响量级约 0.1%/笔，累积效应取决于交易频率

---

### GAP-B10: 模式不区分 → TD/BU 混入

**系统完整性**: 🔴 高
- 如果 `integrated_recommendation` 同时包含 `top_down` 和 `bottom_up` 的记录，回测会把两种模式混在一起
- 与设计的"TD/BU 分别回测、对照验证"意图不符
- 影响 Integration 层的双模式验证闭环

**短期可接受**: 如果当前只运行了 top_down Integration，integrated_recommendation 中只有 TD 记录。

---

## P2 — 中（精细化改进）

### GAP-B11 成交概率模型 / GAP-B12 停牌处理

**业务风险**: 🟡 低
- 成交概率模型差异影响的是排队撮合精度，对回测结果的影响属于二阶效应
- 停牌处理在 GAP-B01 "次日清仓"行为下影响极小，修复 B01 后变得重要

### GAP-B16/B17 表结构偏离

**系统影响**: 🟡 中
- 影响审计数据完整性和跨文档查询一致性
- 代码中有价值的额外字段（`reject_reason`, `limit_guard_result`, `bridge_check_status`）需要反哺设计

---

## P3 — 低（不影响核心功能）

### GAP-B13/B14/B15/B18/B19

- 架构和数据结构差异不影响当前运行正确性
- 枚举缺失不影响运行时行为（字符串常量语义等效）
- 设计未涉及的概念（S3/S3R, bridge, A/B/C proxy）是代码的有价值增量
- 建议后续以代码有价值的部分反哺设计

---

## 风险传导链分析

```
GAP-B01 (卖出逻辑退化)
  └→ 所有交易都是"买入→次日卖"
       └→ 回测收益/回撤/胜率全部失真
            └→ GAP-B07 绩效指标（即使补算）仍基于错误交易
                 └→ Analysis 层绩效评估/偏差归因全部失真
                      └→ Trading 层参考回测结果做的决策不可靠

GAP-B04 (RR<1 全局阻断)
  └→ integrated_recommendation 中只要有一条 RR<1 记录
       └→ 整个回测标记为 P0 error，零交易
            └→ 回测产出空结果
                 └→ Analysis 层无数据可消费

GAP-B05 (Gate 全局阻断)
  └→ 回测窗口内某一天 Gate=FAIL
       └→ 整个回测零交易
            └→ 同上

GAP-B02 + B03 (公式/口径错误)
  └→ max_drawdown 和 total_return 数值不正确
       └→ Analysis 消费错误值 → 绩效对比失真
            └→ Calmar Ratio / 年化收益计算错误
```

## 与其他 SOS 篇的依赖关系

```
Backtest GAP-B07 (绩效指标缺失)
  ├→ 阻塞 Analysis GAP-A01 (绩效硬编码0)
  └→ 阻塞 Analysis GAP-A07 (equity_curve 未持久化)

Backtest GAP-B16 (trade_records 缺费用字段)
  └→ 阻塞 Analysis GAP-A08 (回测交易记录缺费用明细)
  └→ 导致 Analysis GAP-A15 (bt_cost_rate 硬编码0)

Backtest GAP-B01 (卖出逻辑退化)
  └→ 导致 trade_records 中无 hold_days
  └→ 阻塞 Analysis GAP-A12 (持仓天数缺失)
```
