# ENH-10/11 + 调度编排 + 监控告警 — 设计 vs 代码差异报告

**严重度**: 🔴 严重（监控模块仅占位）+ 🟡 中等（调度器参数偏差 / DAG 未完整实现）+ 🟢 轻微（ENH-10）
**涉及设计**: `scheduler-orchestration-design.md`, `monitoring-alerting-design.md`, `eq-improvement-plan-core-frozen` §4 ENH-10/11
**涉及代码**: `src/pipeline/scheduler.py`, `src/pipeline/main.py`, `src/monitoring/quality_monitor.py`, `src/data/fetch_batch_pipeline.py`

---

## ENH-10 数据采集增强

### 1.1 🟢 基本对齐

| 维度 | 设计规格 | 实际代码 | 状态 |
|------|---------|---------|------|
| 分批下载 | ✅ | `run_fetch_batch()` 按 batch window 切分 | ✅ |
| 断点续传 | ✅ | `fetch_progress.json` 持久化 + `run_fetch_retry()` | ✅ |
| 多线程 | ✅ | `ThreadPoolExecutor(max_workers=workers)` | ✅ |
| CLI 入口 | `eq fetch-batch`, `eq fetch-status` | 两个子命令均已实现 | ✅ |
| 产出 | `fetch_progress.json`, `fetch_retry_report.md`, `throughput_benchmark.md` | 三个产物均输出 | ✅ |
| batch-unit | 天/月/年 | `day/month/year` 支持 | ✅ |

**结论**: ENH-10 是实现最完整的增强项之一，与设计高度对齐。

### 1.2 建议

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R10-1 | 无需修改 | — | — |

---

## ENH-11 定时调度器

### 2.1 🟢 骨架对齐 + 🟡 重试参数偏差

| 维度 | 设计规格 | 实际代码 | 状态 |
|------|---------|---------|------|
| CLI 入口 | `eq scheduler install/status/run-once` | 三个子命令均已实现 | ✅ |
| CalendarGuard | 交易日判定 | `check_trade_calendar()` | ✅ |
| 幂等检查 | `trade_date + module` | `check_idempotency(task_name, trade_date)` | ✅ |
| 执行记录 | DuckDB task_execution_log | DDL + CRUD 完整 | ✅ |
| 默认调度时间 | — | `DEFAULT_SCHEDULE_TIME = "16:00"` | ✅ |

### 2.2 🟡 重试策略与设计严重偏差

| 维度 | 设计规格 (scheduler-orchestration-design §重试) | 实际代码 (scheduler.py) |
|------|---------|---------|
| 最大重试次数 | **5 次** | **3 次** (`MAX_RETRY_COUNT = 3`) |
| 重试策略 | **指数退避** (30s, 60s, 120s, 240s, 480s) | **固定间隔** (`RETRY_INTERVAL_SECONDS = 300`，即 5 分钟) |
| 最大延迟 | 480s (8 分钟) | 300s (5 分钟) |

**影响**: 固定 5 分钟重试间隔过长（第一次重试就要等 5 分钟），而设计的指数退避从 30s 开始更合理。

---

### 2.3 建议

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R11-1 | `MAX_RETRY_COUNT` 改为 5 | 修订代码 | P1 |
| R11-2 | 重试策略从固定间隔改为指数退避 `delay = min(30 * 2^n, 480)` | 修订代码 | P1 |

---

## 调度编排设计 (scheduler-orchestration-design.md)

### 3.1 🟡 DAG 编排实现不完整

| 维度 | 设计规格 | 实际代码 |
|------|---------|---------|
| DAG 执行 | 按依赖图编排，支持并行 | `_run_all()` 串行 for 循环 |
| 执行约束 | Data 未完成禁止算法启动 | 无显式约束检查，依赖串行顺序 |
| Validation Gate 阻断 | FAIL 则阻断 Integration | 无显式 Gate 检查（依赖 recommend 内部逻辑） |
| `blocked_by_dependency` 标记 | 下游任务自动跳过并标记 | 不存在 |

**实际 `_run_all()` 实现** (`src/pipeline/main.py` L1438-L1521):
```
步骤序列:
1. run --l1-only      (L1 采集)
2. run --to-l2        (L2 聚合)
3. mss                (MSS 评分)
4. irs                (IRS 评分)
5. pas                (PAS 评分)
6. recommend --integrated --with-validation  (集成推荐)
```
纯串行执行，任何步骤返回非零退出码直接终止。

**缺失的设计能力**:
- MSS/IRS/PAS 可以并行但实际串行
- 无 Backtest/Trading/Analysis/GUI 步骤（只到 recommend 就停）
- 无 `blocked_by_dependency` 失败补偿机制
- 无手动重跑单节点能力

---

### 3.2 🟡 数据就绪检查点未实现

设计定义了 6 个数据就绪检查点，每个有超时阈值：

| 检查点 | 超时 | 实际实现 |
|--------|------|---------|
| `raw_trade_cal` | 2 分钟 | ❌ 无超时检查 |
| `raw_daily` | 10 分钟 | ❌ 无超时检查 |
| `raw_index_daily` | 5 分钟 | ❌ 无超时检查 |
| `raw_index_classify(SW2021)` | 5 分钟 | ❌ 无超时检查 |
| `validation_gate_decision` | 2 分钟 | ❌ 无超时检查 |
| `integrated_recommendation` | 3 分钟 | ❌ 无超时检查 |

---

### 3.3 🟡 调度窗口未实现

设计定义了 4 个调度窗口，代码中没有任何时段限制逻辑：

| 窗口 | 时间 | 实际实现 |
|------|------|---------|
| 盘后主计算 | 15:30-18:30 | ❌ 无时段限制 |
| 夜间补算 | 19:00-22:00 | ❌ 无时段限制 |
| 盘前准备 | 08:30-09:20 | ❌ 无时段限制 |
| 交易执行 | 09:30-15:00 | ❌ 无时段限制 |

---

### 3.4 建议

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R-SCH-1 | `_run_all()` 补齐 Backtest/Trading/Analysis/GUI 步骤 | 修订代码 | P1 |
| R-SCH-2 | 为 MSS/IRS/PAS 加入并行执行能力（ThreadPoolExecutor） | 修订代码 | P2 |
| R-SCH-3 | 实现 `blocked_by_dependency` 失败补偿 | 修订代码 | P2 |
| R-SCH-4 | 实现数据就绪检查点超时机制 | 修订代码 | P2 |
| R-SCH-5 | 调度窗口实现或修订设计将其标为延后项 | 双向讨论 | P3 |

---

## 监控告警设计 (monitoring-alerting-design.md)

### 4.1 🔴 监控模块仅占位

**设计内容**（`monitoring-alerting-design.md`）:
- 定义了 6 层监控范围（数据层/因子层/Validation 层/集成层/交易层/系统层）
- 定义了 9 条关键指标与阈值
- 定义了 P0/P1/P2 三级告警
- 定义了升级规则（P1 连续 3 次 → P0，P2 连续 10 次 → P1）
- 定义了通知路径（控制台 + 日志 + 即时消息）
- 定义了指数退避重试策略（base=30s, max_delay=480s, max_retries=5）

**实际代码** (`src/monitoring/quality_monitor.py`):
```python
class QualityMonitor:
    """质量监控占位实现。"""
    def check(self) -> dict[str, Any]:
        raise NotImplementedError("QualityMonitor.check is not implemented")
```

**代码总共 16 行**，只有一个 `NotImplementedError`。设计文档定义了 76 行详尽的监控规格，代码中几乎完全没有落地。

---

### 4.2 部分监控能力散落在其他模块

虽然 `quality_monitor.py` 是空的，但一些监控能力分散在其他地方：

| 设计指标 | 散落位置 | 状态 |
|---------|---------|------|
| 数据完整性 | `src/data/quality_gate.py` 和 `quality_store.py` | 🟡 有基础实现 |
| Validation Gate | `src/algorithms/validation/pipeline.py` 输出 PASS/WARN/FAIL | 🟡 有 |
| `final_score` 越界 | `src/integration/pipeline.py` 有边界校验 | 🟡 有 |
| 任务耗时 | `scheduler.py` 的 `task_execution_log` 记录 duration_seconds | 🟡 有 |

但缺失：
- ❌ P0/P1/P2 告警分级系统
- ❌ 告警升级规则
- ❌ 通知路径（即时消息）
- ❌ `stale_days` 超阈值监控
- ❌ 下单失败率监控
- ❌ 单任务连续失败熔断

---

### 4.3 建议

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R-MON-1 | 补齐 `src/monitoring/quality_monitor.py` 实现 P0/P1/P2 分级 | 修订代码 | **P0** |
| R-MON-2 | 整合散落的监控能力到统一接口 | 修订代码 | P1 |
| R-MON-3 | 实现告警升级规则 | 修订代码 | P2 |
| R-MON-4 | 通知路径至少实现控制台 + 日志 | 修订代码 | P2 |
| R-MON-5 | 重试策略统一为指数退避 (base=30s, max_delay=480s, max_retries=5) | 修订代码 | P1 |
