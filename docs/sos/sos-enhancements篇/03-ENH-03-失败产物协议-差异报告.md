# ENH-03 å¤±è´¥äº§ç‰©åè®® â€” è®¾è®¡ vs ä»£ç å·®å¼‚æŠ¥å‘Š

**ä¸¥é‡åº¦**: ğŸŸ¡ ä¸­ç­‰
**æ¶‰åŠè®¾è®¡**: `enhancement-selection-analysis` Â§2 ENH-03
**æ¶‰åŠä»£ç **: `src/data/l1_pipeline.py`, `src/data/l2_pipeline.py`, `src/algorithms/mss/pipeline.py`, `src/pipeline/recommend.py`, `src/backtest/pipeline.py`, `src/trading/pipeline.py`, `src/stress/pipeline.py`, `src/analysis/pipeline.py`

---

## 1. å·®å¼‚æ¸…å•

### 1.1 ğŸŸ¡ error_manifest æ ¼å¼ä¸ç»Ÿä¸€

**è®¾è®¡è§„æ ¼**ï¼ˆENH-03 æœ€å°å­—æ®µï¼‰:
```json
{
  "error_level": "P0",
  "step": "fetch_daily",
  "trade_date": "20260207",
  "error_type": "TuShareAPIError",
  "message": "...",
  "timestamp": "..."
}
```

**å®é™…ä»£ç **ï¼ˆä»¥ `l1_pipeline.py` ä¸ºä¾‹ï¼‰:
```json
{
  "trade_date": "20260207",
  "source": "tushare",
  "error_count": 1,
  "errors": [
    {
      "dataset": "raw_daily",
      "error_type": "fetch_failed",
      "message": "..."
    }
  ]
}
```

**å…·ä½“ç¼ºå¤±å­—æ®µ**:

| è®¾è®¡è¦æ±‚å­—æ®µ | å®é™…ä»£ç  | å·®å¼‚ |
|-------------|---------|------|
| `error_level` (P0/P1/P2) | âŒ ä¸å­˜åœ¨ | ğŸŸ¡ æ— æ³•ä¸ç›‘æ§å‘Šè­¦è®¾è®¡ P0/P1/P2 ä½“ç³»å¯¹æ¥ |
| `step` (å¤±è´¥æ­¥éª¤) | âŒ ä¸å­˜åœ¨ï¼ˆç”¨ `dataset` éƒ¨åˆ†æ›¿ä»£ï¼‰ | ğŸŸ¡ è¯­ä¹‰ä¸å®Œå…¨ç­‰ä»· |
| `timestamp` | âŒ ä¸å­˜åœ¨ | ğŸŸ¡ æ— æ³•ç²¾ç¡®å®šä½å¤±è´¥æ—¶é—´ |
| `trade_date` | âœ… å­˜åœ¨ | â€” |
| `error_type` | âœ… å­˜åœ¨ | â€” |
| `message` | âœ… å­˜åœ¨ | â€” |

---

### 1.2 ğŸŸ¡ å†™å…¥ä½ç½®ä¸ç»Ÿä¸€

| ç»´åº¦ | è®¾è®¡è§„æ ¼ | å®é™…ä»£ç  |
|------|---------|---------|
| å†™å…¥ä½ç½® | `${DATA_PATH}/error_manifest.json` | å„æ¨¡å—çš„ `artifacts/spiral-s{N}/{trade_date}/error_manifest.json` |
| è¦†ç›–ç­–ç•¥ | æœ€åä¸€æ¬¡å¤±è´¥è¦†ç›–å†™å…¥ï¼Œä¸ç´¯ç§¯ | å„æ¨¡å—ç‹¬ç«‹å†™å…¥å„è‡ª artifacts ç›®å½• |

**è¯¦æƒ…**: è®¾è®¡è¦æ±‚ä¸€ä¸ªå…¨å±€ç»Ÿä¸€ä½ç½®ï¼Œä»£ç å®é™…ä¸Šæ¯ä¸ªæ¨¡å—åœ¨å„è‡ªçš„ artifacts å­ç›®å½•ä¸­å†™å…¥å„è‡ªçš„ error_manifest.jsonã€‚

**å½±å“**: æ— æ³•é€šè¿‡æŸ¥çœ‹ä¸€ä¸ªæ–‡ä»¶äº†è§£å…¨é“¾è·¯æœ€åä¸€æ¬¡å¤±è´¥ï¼›éœ€è¦éå†å¤šä¸ª artifacts ç›®å½•ã€‚

---

### 1.3 ğŸŸ¡ ç¼ºå°‘ç»Ÿä¸€å†™å…¥å‡½æ•°

| ç»´åº¦ | è®¾è®¡è§„æ ¼ | å®é™…ä»£ç  |
|------|---------|---------|
| å®ç°æ–¹å¼ | "ç»Ÿä¸€ error_manifest å†™å…¥å‡½æ•°" | å„æ¨¡å—ç‹¬ç«‹å®ç° `_write_json()` å†™å…¥ |

**è¯¦æƒ…**: è®¾è®¡è¦æ±‚ä¸€ä¸ªå…¬å…±çš„ error_manifest å†™å…¥å‡½æ•°åœ¨å…³é”®æ­¥éª¤ catch åè°ƒç”¨ã€‚ä»£ç ä¸­æ¯ä¸ªæ¨¡å—å„è‡ªæ„é€  payload å¹¶è°ƒç”¨å†…éƒ¨ `_write_json()`ï¼Œæ ¼å¼ä¸å®Œå…¨ä¸€è‡´ã€‚

**å…·ä½“å®ç°ä½ç½®**ï¼ˆå·²ç¡®è®¤çš„ error_manifest å†™å…¥æ¨¡å—ï¼‰:
- `src/data/l1_pipeline.py` (L423-L434) âœ… æœ‰å†™å…¥
- `src/data/l2_pipeline.py` âœ… æœ‰å†™å…¥
- `src/data/fetch_batch_pipeline.py` âœ… æœ‰å†™å…¥
- `src/algorithms/mss/pipeline.py` âœ… æœ‰å†™å…¥
- `src/algorithms/mss/probe.py` âœ… æœ‰å†™å…¥
- `src/pipeline/recommend.py` âœ… æœ‰å†™å…¥
- `src/backtest/pipeline.py` âœ… æœ‰å†™å…¥
- `src/trading/pipeline.py` âœ… æœ‰å†™å…¥
- `src/stress/pipeline.py` âœ… æœ‰å†™å…¥
- `src/analysis/pipeline.py` âœ… æœ‰å†™å…¥

---

### 1.4 âœ… å·²å¯¹é½é¡¹

- âœ… error_manifest.json æ–‡ä»¶åœ¨å„æ¨¡å—ä¸­å‡æœ‰è¾“å‡º
- âœ… å¤±è´¥æ—¶å†™å…¥ error_manifest.jsonï¼ŒæˆåŠŸæ—¶å†™å…¥ error_manifest_sample.json
- âœ… CLI è¾“å‡º JSON ä¸­åŒ…å« `error_manifest_path` å­—æ®µ
- âœ… å…·æœ‰ `has_error` æ ‡è®°

---

## 2. å»ºè®®ä¿®è®¢æ–¹æ¡ˆ

| ç¼–å· | åŠ¨ä½œ | æ–¹å‘ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| R03-1 | åœ¨æ¯ä¸ª error é¡¹ä¸­è¡¥å…… `error_level` (P0/P1/P2) å­—æ®µ | ä¿®è®¢ä»£ç  | P1 |
| R03-2 | åœ¨æ¯ä¸ª error é¡¹ä¸­è¡¥å…… `timestamp` å­—æ®µ | ä¿®è®¢ä»£ç  | P2 |
| R03-3 | å°† `dataset` å­—æ®µç»Ÿä¸€æ”¹ä¸º `step`ï¼ˆæˆ–åŒæ—¶ä¿ç•™ä¸¤è€…ï¼‰ | ä¿®è®¢ä»£ç  | P2 |
| R03-4 | æŠ½å–å…¬å…± `write_error_manifest()` å‡½æ•°åˆ° `src/pipeline/error_manifest.py` | ä¿®è®¢ä»£ç  | P1 |
| R03-5 | è®¾è®¡æ–‡æ¡£ä¿®è®¢ï¼šæ‰¿è®¤ per-module artifacts ç›®å½•æ–¹å¼ï¼ˆæ›´å®ç”¨ï¼‰ï¼Œæ”¾å¼ƒå…¨å±€å•æ–‡ä»¶è¦†ç›–å†™å…¥ | ä¿®è®¢è®¾è®¡ | P2 |
