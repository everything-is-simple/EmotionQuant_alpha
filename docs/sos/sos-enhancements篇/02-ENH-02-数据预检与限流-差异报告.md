# ENH-02 数据预检与限流守卫 — 设计 vs 代码差异报告

**严重度**: 🔴 严重（validate_token 缺失）+ 🟡 中等（框架与异常体系偏差）
**涉及设计**: `enhancement-selection-analysis` §2 ENH-02
**涉及代码**: `src/data/fetcher.py`

---

## 1. 差异清单

### 1.1 🔴 `validate_token()` 预检函数完全缺失

| 维度 | 设计规格 | 实际代码 |
|------|---------|---------|
| Token 预检 | `validate_token()` 调 `tushare.pro_api().trade_cal()` 小请求验通 | 不存在任何 `validate_token` 函数 |

**详情**: 设计明确要求在数据采集前通过一个轻量请求验证 token 有效性。代码中完全没有此功能——token 无效时会在第一次正式请求时才暴露错误。

**影响**:
- 用户首次运行时 token 配置错误无法快速定位
- 超频被封后无法在入口处给出明确提示

**建议**: 🔧 在 `TuShareFetcher.__init__()` 或独立函数中补齐 token 预检（方案 B）。

---

### 1.2 🟡 重试框架偏差

| 维度 | 设计规格 | 实际代码 |
|------|---------|---------|
| 重试框架 | `tenacity` 库 `@retry(stop=stop_after_attempt(3), wait=wait_exponential())` | 自定义 for 循环重试（`fetch_with_retry()`） |
| 重试次数 | 3 次 | `max_retries=3`（默认值） ✅ |
| 重试策略 | 指数退避（tenacity） | 无退避等待，直接重试 |

**详情**: 设计要求使用 tenacity 装饰器实现重试，代码用自定义 for 循环。重试次数一致（3 次），但代码在重试之间**没有等待/退避**——纯粹是 immediate retry。

**影响**: 对 TuShare API 连续快速重试可能触发限流，但双通道 failover 机制部分缓解了此问题。

**建议**:
- 可接受不用 tenacity（减少依赖），但需在重试循环中加入指数退避等待
- 或修订设计认可当前实现

---

### 1.3 🟡 异常类命名不匹配设计

| 维度 | 设计规格（data-layer-api.md SS10） | 实际代码 |
|------|---------|---------|
| 主异常 | `DataFetchError` | `FetchError` |
| 限流异常 | `RateLimitError` | 不存在（无独立类） |
| 连接异常 | `ConnectionError` | 不存在（统一用 `FetchError`） |

**详情**: 设计要求复用 `data-layer-api.md` 中定义的三种异常类型（`DataFetchError`、`RateLimitError`、`ConnectionError`），代码只有一个 `FetchError` 统一处理所有失败情况。

**影响**: 下游模块无法通过异常类型区分"限流"和"连接失败"，不利于精细化错误处理和告警分级。

**建议**: 🔧 补齐 `RateLimitError` 和 `ConnectionError` 子类（方案 B）；或修订设计认可统一 `FetchError`（方案 A）。

---

### 1.4 ✅ 已对齐项

| 功能 | 状态 |
|------|------|
| 双通道故障转移（primary + fallback） | ✅ 完整实现 |
| 按通道独立限流（`_respect_rate_limit`） | ✅ 完整实现 |
| 限流参数从 Config 读取（不硬编码） | ✅ 完整实现 |
| 交易日历预检 | ✅ 通过 `CalendarGuard` 在 scheduler 层实现 |
| SimulatedTuShareClient 离线模式 | ✅ 存在 |
| retry_report 诊断记录 | ✅ 存在 |

---

## 2. 建议修订方案

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R02-1 | 补齐 `validate_token()` 预检函数 | 修订代码 | **P0** |
| R02-2 | fetch_with_retry 循环中加入指数退避等待 | 修订代码 | P1 |
| R02-3 | 补齐 `RateLimitError` / `ConnectionError` 异常子类，或修订设计认可 `FetchError` | 双向讨论 | P2 |
| R02-4 | 设计文档重试框架描述从 "tenacity" 改为 "自定义重试 + 指数退避" | 修订设计 | P2 |
