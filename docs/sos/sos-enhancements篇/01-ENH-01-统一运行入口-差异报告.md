# ENH-01 统一运行入口 — 设计 vs 代码差异报告

**严重度**: 🟡 中等
**涉及设计**: `enhancement-selection-analysis` §2 ENH-01、`eq-improvement-plan-core-frozen` §4 ENH-01
**涉及代码**: `src/pipeline/main.py`

---

## 1. 差异清单

### 1.1 CLI 框架选型偏差

| 维度 | 设计规格 | 实际代码 | 差异程度 |
|------|---------|---------|---------|
| CLI 框架 | Typer 或 Click | argparse | 🟡 中 |

**详情**: 设计文档 `enhancement-selection-analysis` ENH-01 实现要点明确写了"Typer 或 Click"，但实际使用 `argparse`。

**影响评估**: argparse 是 Python 标准库，功能完整，实际上减少了外部依赖。CLI 外部行为无差别。

**建议**: ✅ 修订设计文档认可 argparse（方案 A），不需要改代码。

---

### 1.2 子命令集合远超设计

| 维度 | 设计规格 | 实际代码 |
|------|---------|---------|
| 设计规定的子命令 | `run`, `mss`, `recommend`, `backtest`, `trade`, `gui`, `run-all` (7 个) | 全部 7 个已实现 ✅ |
| 代码额外子命令 | — | `irs`, `pas`, `mss-probe`, `fetch-batch`, `fetch-retry`, `fetch-status`, `analysis`, `validation`, `stress`, `consistency`, `scheduler`, `version` (12 个额外) |

**详情**: 代码总共有 19 个子命令，设计只列了 7 个。额外的 12 个中：
- `irs`/`pas`/`mss-probe`/`validation` 属于核心算法独立入口
- `fetch-batch`/`fetch-retry`/`fetch-status` 属于 ENH-10 数据采集增强
- `scheduler` 属于 ENH-11 定时调度器
- `analysis`/`stress`/`consistency`/`version` 属于合理扩展

**影响评估**: 额外子命令都有对应的实现支撑，不是空壳。本质上是设计文档未及时跟进实现进度。

**建议**: ✅ 回写设计文档补充完整子命令列表（方案 A）。

---

### 1.3 `--source mock` 路径不完整

| 维度 | 设计规格 | 实际代码 |
|------|---------|---------|
| mock 数据入口 | `eq run --date {date} --source mock` 从 fixtures 读取 | `--source` 参数存在，但无显式 `mock` 数据源路径 |

**详情**: 设计要求 `--source mock` 从 `tests/fixtures/canary_10d/` 读取离线数据。代码中 `--source` 默认值为 `tushare`，当无 token 时自动退化到 `SimulatedTuShareClient`（内存中生成模拟数据），而非从文件读取。

**影响评估**: 功能等价——都能在无网络时运行，但实现方式不同。SimulatedTuShareClient 生成的数据与文件 fixtures 不同。

**建议**: 🔶 需讨论——是否需要一个从 parquet fixtures 读取的 `--source mock` 路径。此条与 ENH-05 金丝雀数据包紧密关联。

---

## 2. 已对齐项（无问题）

- ✅ `eq run --date YYYYMMDD` 基本入口
- ✅ `eq mss/recommend/backtest/trade/gui/run-all` 全部实现
- ✅ 所有子命令有实际函数支撑（无空壳）
- ✅ `--print-config` 注入 Config 快照
- ✅ `--env-file` 支持
- ✅ 统一 JSON 输出格式

---

## 3. 建议修订方案

| 编号 | 动作 | 方向 | 优先级 |
|------|------|------|--------|
| R01-1 | 设计文档 ENH-01 框架选型改为 "argparse（标准库）" | 修订设计 | P2 |
| R01-2 | 设计文档补充完整的 19 个子命令列表 | 修订设计 | P1 |
| R01-3 | 讨论是否需要 `--source mock` 从文件 fixtures 读取 | 双向讨论 | P2 |
