# C1 ğŸ”´ ä¼°å€¼å› å­å½’ä¸€åŒ–è·¯å¾„ä¸ä¸€è‡´

## é—®é¢˜å®šä½

- **è®¾è®¡æ–‡ä»¶**: `docs/design/core-algorithms/irs/irs-algorithm.md` Â§3.4 (line 177-179)
- **ä»£ç æ–‡ä»¶**: `src/algorithms/irs/pipeline.py` (line 498-533)
- **ä»£ç æ–‡ä»¶**: `src/algorithms/irs/calculator.py` (line 189-224)

## å·®å¼‚æè¿°

### è®¾è®¡è§„å®šï¼ˆå…ˆzååˆå†zï¼‰

```
valuation_raw = w_pe(style) Ã— normalize_zscore(-industry_pe_ttm)
              + w_pb(style) Ã— normalize_zscore(-industry_pb)
valuation_score = normalize_zscore(valuation_raw)
```

æ‰§è¡Œæ­¥éª¤ï¼š
1. å¯¹ `-pe_ttm` åš z-score â†’ å¾—åˆ° 0-100 èŒƒå›´çš„ PE åˆ†æ•°
2. å¯¹ `-pb` åš z-score â†’ å¾—åˆ° 0-100 èŒƒå›´çš„ PB åˆ†æ•°
3. æŒ‰ style_bucket æƒé‡åŠ æƒç»„åˆ â†’ å¾—åˆ° valuation_rawï¼ˆä¹Ÿæ˜¯ 0-100 èŒƒå›´ï¼‰
4. å¯¹ valuation_raw å†åšä¸€æ¬¡ z-score â†’ å¾—åˆ°æœ€ç»ˆ valuation_score

### ä»£ç å®ç°ï¼ˆå…ˆåˆåzï¼‰

```python
# pipeline.py:498-533
valuation_raw_series = w_pe * (-pe_series) + w_pb * (-pb_series)
valuation_raw = float(valuation_raw_series.iloc[-1])
# ...
valuation_score, ... = _score_with_history(value=valuation_raw, ...)
```

æ‰§è¡Œæ­¥éª¤ï¼š
1. å¯¹åŸå§‹ `-pe_ttm` å’Œ `-pb` æŒ‰ style_bucket æƒé‡åŠ æƒæ±‚å’Œ â†’ å¾—åˆ° valuation_raw
2. å¯¹ valuation_raw åšä¸€æ¬¡ z-score â†’ å¾—åˆ° valuation_score

## ä¸ºä»€ä¹ˆè¿™æ˜¯è‡´å‘½é—®é¢˜

PE_TTM çš„å…¸å‹èŒƒå›´æ˜¯ 10~100ï¼ˆç”šè‡³æ›´å¤§ï¼‰ï¼ŒPB çš„å…¸å‹èŒƒå›´æ˜¯ 1~10ã€‚

**ä»£ç è·¯å¾„**ï¼ˆå…ˆåˆåzï¼‰ï¼š`raw = 0.65 Ã— (-50) + 0.35 Ã— (-3) = -33.55`
â†’ PE å› ä¸ºç»å¯¹å€¼å¤§ï¼Œä¸»å¯¼äº†ç»“åˆç»“æœï¼ŒPB çš„ 0.35 æƒé‡å½¢åŒè™šè®¾ã€‚

**è®¾è®¡è·¯å¾„**ï¼ˆå…ˆzååˆå†zï¼‰ï¼šå…ˆæŠŠ PE å’Œ PB å„è‡ªæ˜ å°„åˆ° 0-100 åŒä¸€å°ºåº¦ï¼Œå†æŒ‰æƒé‡ç»„åˆ
â†’ æƒé‡æ‰èƒ½çœŸæ­£åæ˜ è®¾è®¡æ„å›¾ï¼ˆæ¯”å¦‚ growth è¡Œä¸š PB æƒé‡åº”è¯¥æ›´é«˜ï¼‰ã€‚

## æ–¹æ¡ˆé€‰é¡¹

### æ–¹æ¡ˆ Aï¼šä»£ç å‘è®¾è®¡å¯¹é½ï¼ˆæ¨è âœ…ï¼‰

ä¿®æ”¹ pipeline.py å’Œ calculator.pyï¼Œå¯¹ PE å’Œ PB å…ˆå„è‡ª z-scoreï¼Œå†åŠ æƒç»„åˆï¼Œå†åšæœ€ç»ˆ z-scoreã€‚

**pipeline.py ä¿®æ”¹è¦ç‚¹**ï¼š
```python
# æ›¿æ¢å½“å‰çš„ï¼ˆline 498-533ï¼‰:
# valuation_raw_series = w_pe * (-pe_series) + w_pb * (-pb_series)

# æ”¹ä¸ºï¼š
pe_score, pe_mean, pe_std = _score_with_history(
    value=float((-pe_series).iloc[-1]),
    history_series=-pe_series,
    baseline_map=baseline_map,
    baseline_key="irs_valuation_pe_raw",
)
pb_score, pb_mean, pb_std = _score_with_history(
    value=float((-pb_series).iloc[-1]),
    history_series=-pb_series,
    baseline_map=baseline_map,
    baseline_key="irs_valuation_pb_raw",
)
valuation_raw = w_pe * pe_score + w_pb * pb_score
# å†å¯¹ valuation_raw åšæœ€ç»ˆ z-score
valuation_score, valuation_mean, valuation_std = _score_with_history(
    value=valuation_raw,
    history_series=...,  # éœ€è¦æ„é€ å†å² valuation_raw åºåˆ—
    baseline_map=baseline_map,
    baseline_key="irs_valuation_raw",
)
```

**å½±å“**ï¼š
- éœ€è¦æ–°å¢ baseline_key `irs_valuation_pe_raw` å’Œ `irs_valuation_pb_raw`
- factor_intermediate è¡¨å¯èƒ½éœ€è¦å¢åŠ  PE/PB å„è‡ªçš„ mean/std å¿«ç…§
- è¯„åˆ†ç»“æœä¼šå‘ç”Ÿå˜åŒ–ï¼ˆè¿™æ˜¯é¢„æœŸçš„ï¼Œå› ä¸ºåŸå®ç°æœ‰ bugï¼‰

### æ–¹æ¡ˆ Bï¼šè®¾è®¡å‘ä»£ç å¯¹é½

ä¿®æ”¹è®¾è®¡æ–‡æ¡£ Â§3.4 å…¬å¼ä¸ºï¼š
```
valuation_raw = w_pe(style) Ã— (-industry_pe_ttm) + w_pb(style) Ã— (-industry_pb)
valuation_score = normalize_zscore(valuation_raw)
```

**é—®é¢˜**ï¼šè¿™æ ·åšè™½ç„¶å¿«ï¼Œä½† PE/PB é‡çº²å·®å¼‚å¯¼è‡´æƒé‡åå­˜å®äº¡ã€‚
å¯¹äº growth è¡Œä¸šï¼ˆw_pe=0.35, w_pb=0.65ï¼‰ï¼ŒPB æƒé‡è™½é«˜ä½†ç»å¯¹å€¼å°ï¼Œ
å®é™…æ•ˆæœæ¥è¿‘ PE ç‹¬å â€”â€”è¿èƒŒè®¾è®¡åˆè¡·ã€‚

**ä¸æ¨è** âŒ

### æ–¹æ¡ˆ Cï¼šæŠ˜ä¸­ â€” å…ˆåˆåzï¼Œä½†é¢„å¤„ç†é‡çº²å¯¹é½

åœ¨ç»„åˆå‰å¯¹ PE å’Œ PB åš min-max æˆ– rank å½’ä¸€åŒ–ï¼ˆè€Œé z-scoreï¼‰ï¼Œè®©ä¸¤è€…åœ¨åŒä¸€é‡çº²ï¼š
```
pe_normed = rank_pct(-pe_ttm)   # 0~1
pb_normed = rank_pct(-pb)       # 0~1
valuation_raw = w_pe * pe_normed + w_pb * pb_normed
valuation_score = normalize_zscore(valuation_raw)
```

**é—®é¢˜**ï¼šå¼•å…¥äº†è®¾è®¡ä¸­æœªå®šä¹‰çš„ rank_pct æ–¹æ³•ï¼Œä¸å…¨ç³»ç»Ÿ z-score ç»Ÿä¸€è§„èŒƒå†²çªã€‚

**ä¸æ¨è** âŒ

## å»ºè®®

é€‰æ‹© **æ–¹æ¡ˆ A**ï¼Œä»£ç å‘è®¾è®¡å¯¹é½ã€‚ç†ç”±ï¼š
1. è®¾è®¡çš„"å…ˆzååˆ"æ˜¯å¤šå› å­åˆæˆçš„æ ‡å‡†åšæ³•ï¼Œè§£å†³é‡çº²ä¸ä¸€è‡´é—®é¢˜
2. ä¸ Â§4.2 "ç»Ÿä¸€ä½¿ç”¨ Z-Score å½’ä¸€åŒ–"åŸåˆ™ä¸€è‡´
3. style_bucket æƒé‡æ‰èƒ½çœŸæ­£ç”Ÿæ•ˆ
