# M2 🟠 market_amount_total 来源不一致

## 问题定位

- **设计文件**: `docs/design/core-algorithms/irs/irs-data-models.md` §2.1 (line 57)
- **代码文件**: `src/algorithms/irs/pipeline.py` (line 406-410, 460-461)

## 差异描述

### 设计规定

`IrsIndustrySnapshot` 数据模型中定义了字段：

```python
market_amount_total: float   # 全市场成交额（同日）
```

每个行业的快照中都携带了当日全市场成交额，由 L2 聚合层在生成快照时填充。

### 代码实现

```python
# pipeline.py:406-410
market_amount_by_date = (
    history.groupby("trade_date")["industry_amount"].sum().to_dict()
    if not history.empty
    else {}
)

# pipeline.py:460
market_amount_total = industry_hist["trade_date"].map(market_amount_by_date).fillna(amount_series)
```

代码自行通过 `Σ(industry_amount)` 按日期汇总来计算全市场成交额，
完全忽略了 industry_snapshot 中可能存在的 `market_amount_total` 字段。

## 潜在风险

1. **"ALL"聚合行问题**：如果 industry_snapshot 中包含一条 `industry_code="ALL"` 的聚合行，
   `groupby + sum` 会把 ALL 行的 amount 也加进去，导致重复计算。

2. **数据源不一致**：snapshot 中的 `market_amount_total` 可能来自 raw_daily 的全市场聚合
   （包含非申万一级的股票），而代码的 sum(industry_amount) 只是31个申万一级行业的汇总，
   不包含未被分类到行业的股票成交额。两者在数值上会有偏差。

3. **flow_share 精度**：`flow_share = industry_amount / market_amount_total` 用于资金流向因子，
   如果分母偏大或偏小，会系统性影响 flow_share 和 crowding_ratio。

## 方案选项

### 方案 A：优先读快照字段，汇总作兜底（推荐 ✅）

```python
# 优先从 snapshot 读 market_amount_total
if "market_amount_total" in history.columns:
    mat_series = pd.to_numeric(history["market_amount_total"], errors="coerce")
    mat_by_date = history.groupby("trade_date")["market_amount_total"].first().to_dict()
    # 如果某日值为空或0，才回退到汇总
    market_amount_by_date = {}
    fallback_sum = history.groupby("trade_date")["industry_amount"].sum().to_dict()
    for dt in mat_by_date:
        val = mat_by_date[dt]
        if pd.notna(val) and float(val) > 0:
            market_amount_by_date[dt] = float(val)
        else:
            market_amount_by_date[dt] = fallback_sum.get(dt, 0.0)
else:
    market_amount_by_date = (
        history.groupby("trade_date")["industry_amount"].sum().to_dict()
    )
```

**优点**：
- 与设计数据模型一致
- 自动兜底处理字段缺失场景
- 确保 flow_share 精度正确

### 方案 B：设计标注汇总方式也是合法实现

在设计中补充说明：
> market_amount_total 可通过两种方式获取：
> 1. 快照字段直读（推荐）
> 2. 行业 amount 汇总（作为兜底）

**问题**：回避了数值偏差问题，不够严谨。

### 方案 C：仅用汇总并排除 ALL 行

保持代码现状但增加 ALL 行过滤：
```python
valid_history = history[history["industry_code"] != "ALL"]
market_amount_by_date = valid_history.groupby("trade_date")["industry_amount"].sum().to_dict()
```

**问题**：仍然存在"31行业汇总 ≠ 全市场成交额"的数值偏差。

## 建议

选择 **方案 A**，优先读快照字段。
如果决定当前快速修复，至少执行 **方案 C**（排除 ALL 行）作为临时措施。
