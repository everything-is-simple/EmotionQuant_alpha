# m1 🟡 代码输出了设计中不存在的列

## 问题定位

- **设计文件**: `docs/design/core-algorithms/irs/irs-data-models.md` §3.1 (line 103-132) + §4.1 DDL (line 187-222)
- **代码文件**: `src/algorithms/irs/pipeline.py` (line 713-741)

## 差异描述

### 设计输出模型定义的字段

IrsIndustryDaily（§3.1）+ DDL（§4.1）共同定义的字段：
- trade_date, industry_code, industry_name
- industry_score, rank, rotation_status, rotation_slope, rotation_detail
- allocation_advice, allocation_mode, quality_flag, sample_days
- relative_strength, continuity_factor, capital_flow, valuation, leader_score, gene_score
- neutrality
- created_at（DDL 元数据）

### 代码实际输出的额外字段

| 额外字段 | 来源 | 说明 |
|----------|------|------|
| `irs_score` | pipeline.py:566 | industry_score 的完全重复 |
| `recommendation` | pipeline.py:669 | STRONG_BUY/BUY/HOLD/SELL/AVOID 映射 |
| `data_quality` | pipeline.py:575 | 从 snapshot 透传 |
| `stale_days` | pipeline.py:576 | 从 snapshot 透传 |
| `source_trade_date` | pipeline.py:577 | 从 snapshot 透传 |
| `contract_version` | pipeline.py:578 | 固定字符串 "nc-v1" |

## 逐字段分析

### `irs_score`（重复字段）
与 `industry_score` 完全相同。可能是为了兼容下游读 `irs_score` 的旧代码。
**建议**：保留作为兼容别名，但在设计中标注为"兼容字段，等同 industry_score"。

### `recommendation`（最大隐患）
使用了一套**与设计完全无关**的映射规则：
```python
def _to_recommendation(score: float) -> str:
    if score >= 75.0: return "STRONG_BUY"
    if score >= 70.0: return "BUY"
    if score >= 50.0: return "HOLD"
    if score >= 30.0: return "SELL"
    return "AVOID"
```

设计中 IRS 的配置建议使用 `allocation_advice`（超配/标配/减配/回避）+ 分位动态映射。
`recommendation` 是一个**硬编码阈值映射**，语义与 allocation_advice 不同，
且阈值（75/70/50/30）无任何设计依据。

**问题**：
1. 下游如果同时消费 allocation_advice 和 recommendation，可能出现矛盾信号
2. 用户看到两套建议系统会困惑
3. 阈值缺乏设计依据

**建议**：
- 选项 1（推荐）：从输出中移除 recommendation，下游统一使用 allocation_advice
- 选项 2：如果 recommendation 确实有业务用途，补充设计定义

### `data_quality` / `stale_days` / `source_trade_date`（snapshot 透传）
这些是从 industry_snapshot 透传的质量元数据，对诊断和追溯有用。
**建议**：在设计 DDL 中补充这些字段定义（作为元数据/诊断字段）。

### `contract_version`（内部标记）
用于追踪数据契约版本。
**建议**：在设计 DDL 中补充。

## 总体建议

1. `recommendation` → **移除或补充设计定义**（优先移除）
2. `irs_score` → **在设计中标注为兼容别名**
3. 其余透传/元数据字段 → **在设计 DDL 中补充定义**
