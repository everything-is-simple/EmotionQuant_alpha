# SOS — IRS 系统代码与核心设计差异急救方案

**创建时间**: 2026-02-27
**触发原因**: 独立审计发现 IRS 代码实现与核心设计文档之间存在多处实质性差异
**涉及代码**: `src/algorithms/irs/pipeline.py`, `src/algorithms/irs/calculator.py`
**涉及设计**: `docs/design/core-algorithms/irs/irs-algorithm.md` (v3.3.0)

---

## 一、问题全景

| 编号 | 严重度 | 问题摘要 | 详见 |
|------|--------|----------|------|
| C1 | 🔴 致命 | 估值因子归一化路径：设计"先z后合再z"，代码"先合后z" | 01-C1 |
| C2 | 🔴 致命 | 龙头因子归一化路径：设计"先z后合"，代码"先合后z" | 02-C2 |
| C3 | 🔴 致命 | calculator.py 估值因子硬编码 0.5/0.5，忽略 style_bucket | 03-C3 |
| M1 | 🟠 中度 | 基因库因子数据源语义偏差（当日快照 vs 3年滚动累计） | 04-M1 |
| M2 | 🟠 中度 | market_amount_total 来源不一致（快照字段 vs 自行汇总） | 05-M2 |
| M3 | 🟠 中度 | calculator.py 的 quality_flag 缺少 stale_days 判断 | 06-M3 |
| m1 | 🟡 轻度 | 代码输出了设计中不存在的列（recommendation 等） | 07-m1 |
| m2 | 🟡 轻度 | gene_score 文档字符串提及不存在的"强势率" | 08-m2 |

---

## 二、核心矛盾

这些差异的**根源**可归纳为两类：

### 类型 A：归一化路径分歧（C1, C2）

设计文档对多子因子的因子采用了**"先标准化后组合"**的思路：
- 每个子因子独立 z-score → 加权合并 → 有的因子再做一次 z-score

代码统一采用了**"先组合后标准化"**：
- 子因子原始值加权合并 → 对组合结果做一次 z-score

两种路径**数学上不等价**。PE（量级~10-100）和 PB（量级~1-10）直接加权时，PE 会因量纲差异主导结果。

### 类型 B：实现偷工减料 / 副本漂移（C3, M1, M2, M3）

`calculator.py` 是 `pipeline.py` 的抽取副本（TD-DA-001 试点），但抽取时丢失了：
- style_bucket 生命周期映射（C3）
- stale_days 质量标记逻辑（M3）

基因库因子和 market_amount_total 则是 pipeline.py 本身就与设计有偏差。

---

## 三、急救原则

1. **以"设计→代码"为主方向** — 设计经过多轮 review 沉淀，代码应向设计对齐
2. **若设计不合理** — 先修订设计，再改代码，留变更记录
3. **pipeline.py 为主链** — 优先修复 pipeline.py，calculator.py 同步对齐
4. **不扩大爆炸半径** — 每个修复独立可验证，不搭便车塞需求
5. **修完必须跑测试** — 确认现有契约测试不被破坏

---

## 四、急救执行顺序（建议）

```
Phase 1 — 致命问题（C1 → C2 → C3）
  ↓ 因为 C1/C2 涉及同一类归一化路径决策，应一起决策
  ↓ C3 是 calculator.py 的独立 bug，可并行修
Phase 2 — 中度问题（M1 → M2 → M3）
  ↓ M1/M2 涉及数据源语义，需确认 industry_snapshot 现有字段
  ↓ M3 是 calculator.py 的独立 bug，可并行修
Phase 3 — 轻度问题（m1 → m2）
  ↓ 文档/docstring 修正，风险最低
```

---

## 五、文件索引

| 文件 | 内容 |
|------|------|
| `01-C1-估值因子归一化路径.md` | C1 问题详情 + 方案选项 |
| `02-C2-龙头因子归一化路径.md` | C2 问题详情 + 方案选项 |
| `03-C3-calculator估值权重硬编码.md` | C3 问题详情 + 修复方案 |
| `04-M1-基因库因子数据源.md` | M1 问题详情 + 方案选项 |
| `05-M2-全市场成交额来源.md` | M2 问题详情 + 方案选项 |
| `06-M3-calculator质量标记缺失.md` | M3 问题详情 + 修复方案 |
| `07-m1-代码多余输出列.md` | m1 问题详情 + 处置建议 |
| `08-m2-docstring错误.md` | m2 问题详情 + 修复方案 |
