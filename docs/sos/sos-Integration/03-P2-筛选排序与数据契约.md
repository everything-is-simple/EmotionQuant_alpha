# P2 筛选排序与数据契约：推荐列表逻辑偏差、Gate 回退遗漏、异常处理差异

**严重等级**: P2（不影响核心算法正确性，但影响推荐列表质量和状态机完整性）
**影响范围**: 推荐列表排序/筛选、IRS 冷启动回退、合约版本处理

---

## P2-1：推荐列表缺少 `final_score >= 55` 主门槛筛选

### 问题描述

设计明确要求 `final_score >= 55` 作为入选推荐列表的主门槛，代码的 `_apply_recommendation_limits()` 函数未包含此筛选。

### 设计原文

> integration-algorithm.md §9.1:
> ```
> 入选条件：
> 1. MSS temperature is not null
> 2. final_score ≥ 55
> ```

### 代码现状

```python
# src/integration/pipeline.py _apply_recommendation_limits() (line 388-415)
# 函数内部只做排序和限额（20/5），无 final_score >= 55 筛选
```

主循环中也没有 final_score 门槛过滤 — 所有通过 RR 过滤的股票都会进入 integrated_rows。

### 具体后果

final_score=30（SELL）或 final_score=20（AVOID）的股票也可能出现在推荐列表中，降低推荐列表的信号质量。

### 修复方案

**方案 A（修代码 — 推荐）**：

修复要点：
1. 在 `_apply_recommendation_limits()` 开头增加：`frame = frame[frame["final_score"] >= 55.0]`
2. 或在主循环中跳过 final_score < 55 的记录（但仍保留在 integrated_recommendation 表中供审计）

建议采用方式2：全量写入 integrated_recommendation 表，但 `_apply_recommendation_limits()` 仅对 final_score >= 55 的记录做排序和限额。

**方案 B（改设计）**：如果认为所有计算结果都应展示（由下游 GUI 筛选），则设计 §9.1 需说明 55 分门槛是"展示建议"而非硬过滤。

### 涉及文件

- `src/integration/pipeline.py`

---

## P2-2：推荐列表排序规则不同

### 问题描述

设计的排序规则与代码实现完全不同。

### 设计原文

> integration-algorithm.md §9.1:
> ```
> 排序规则：
> 1. 首先按 final_score 降序
> 2. 然后按 opportunity_score 降序（PAS 软排序）
> 3. 最后按 allocation_advice 优先级降序（IRS 软排序）
> ```

### 代码现状

```python
# src/integration/pipeline.py line 394-398
ranked = ranked.sort_values(
    by=["__grade_priority", "__recommendation_priority", "final_score", "position_size"],
    ascending=[True, True, False, False],
    kind="stable",
)
```

排序维度对比：

| 维度序号 | 设计 | 代码 |
|----------|------|------|
| 第1维 | final_score 降序 | opportunity_grade 优先级（S>A>B>C>D） |
| 第2维 | opportunity_score 降序 | recommendation 优先级（STRONG_BUY>BUY>...） |
| 第3维 | allocation_advice 优先级降序 | final_score 降序 |
| 第4维 | — | position_size 降序 |

### 具体后果

代码中 S 级永远排在最前面，即使 final_score 较低。设计中 final_score 是第一排序键。

例：stock_A(grade=A, final_score=85) vs stock_B(grade=S, final_score=60)
- 按设计：stock_A 排在前面（final_score 更高）
- 按代码：stock_B 排在前面（S 级优先）

### 修复方案

**方案 A（修代码）**：改为 `sort_values(by=["final_score", "pas_score", "allocation_priority"], ascending=[False, False, False])`

**方案 B（改设计 — 推荐此差异用方案B）**：代码的排序方式（grade 优先）在实际使用中可能更合理（高质量机会优先展示），设计可更新为反映当前行为并说明理由。

### 涉及文件

- `src/integration/pipeline.py`
- `docs/design/core-algorithms/integration/integration-algorithm.md` §9.1

---

## P2-3：代码额外的 RR<1.0 硬过滤不在设计中

### 问题描述

代码对 `risk_reward_ratio < 1.0` 的股票直接跳过，设计筛选条件中无此规则。

### 代码现状

```python
# src/integration/pipeline.py line 858-861
risk_reward_ratio = float(getattr(tup, "risk_reward_ratio", 0.0) or 0.0)
if risk_reward_ratio < 1.0:
    rr_filtered_count += 1
    continue
```

### 设计原文

> integration-algorithm.md §9.1 筛选条件仅包含：
> 1. MSS temperature is not null
> 2. final_score ≥ 55

RR 过滤未出现在设计的任何章节中。

### 影响评估

RR < 1.0 意味着预期亏损大于预期收益，从风控角度过滤是合理的。这可能是代码中的一项"合理但未文档化"的工程决策。

### 修复方案

**方案 A（改设计 — 推荐）**：在设计 §9.1 中补充 RR 过滤规则：
```
入选条件（增补）：
3. risk_reward_ratio ≥ 1.0（RR 不达标的股票不参与集成计算）
```

**方案 B（修代码）**：如果认为 RR 过滤不应在 Integration 层做（应在 PAS 层已过滤），则移除此逻辑。

### 涉及文件

- `docs/design/core-algorithms/integration/integration-algorithm.md` §9.1
- 或 `src/integration/pipeline.py`

---

## P2-4：IRS cold_start/stale 回退不强制 baseline 权重

### 问题描述

设计要求 IRS 数据质量异常（cold_start/stale）时强制回退到 baseline 权重，代码仅设置了 WARN 状态和 position_cap，但未重置权重。

### 设计原文

> integration-algorithm.md §3.1:
> ```python
> if irs_quality_flag in {"cold_start", "stale"}:
>     state = "warn_data_cold_start" if irs_quality_flag == "cold_start" else "warn_data_stale"
>     return BASELINE_WEIGHTS, "WARN", state, min(position_cap_ratio, 0.80)
> ```
> 返回值第一项明确是 `BASELINE_WEIGHTS`。

### 代码现状

```python
# src/integration/pipeline.py line 774-781
elif has_cold_start_industry:
    effective_gate = "WARN"
    integration_state = "warn_data_cold_start"
    position_cap_ratio = min(position_cap_ratio, 0.80)
    # ← 缺少：weight_plan_id = "baseline"; w_mss = w_irs = w_pas = BASELINE_WEIGHT
elif has_stale_industry or fallback_plan == "last_valid":
    effective_gate = "WARN"
    integration_state = "warn_data_stale"
    position_cap_ratio = min(position_cap_ratio, 0.80)
    # ← 同样缺少权重回退
```

### 具体后果

如果 Gate 选择了候选权重方案（如 w_mss=0.50, w_irs=0.20, w_pas=0.30），而 IRS 存在 cold_start 行业，设计要求回退到 baseline（各 1/3），但代码会继续使用候选权重。在 IRS 数据不可靠时使用偏重/偏轻某系统的权重，可能放大数据质量问题。

### 修复方案

**方案 A（修代码 — 推荐）**：

修复要点：在 cold_start/stale 分支中增加权重回退：
```python
elif has_cold_start_industry:
    effective_gate = "WARN"
    integration_state = "warn_data_cold_start"
    position_cap_ratio = min(position_cap_ratio, 0.80)
    weight_plan_id = "baseline"            # 新增
    w_mss = BASELINE_WEIGHT                # 新增
    w_irs = BASELINE_WEIGHT                # 新增
    w_pas = BASELINE_WEIGHT                # 新增
```

### 涉及文件

- `src/integration/pipeline.py`

---

## P2-5：合约版本不兼容处理方式偏差

### 问题描述

设计要求合约版本不兼容时抛出 `ContractVersionError` 异常并阻断集成，代码静默跳过并通过 quality_status 报告 FAIL。

### 设计原文

> integration-algorithm.md §2.7:
> ```python
> def assert_contract_version(contract_version: str) -> None:
>     if contract_version != SUPPORTED_CONTRACT_VERSION:
>         raise ContractVersionError(...)
> ```
> 规则：版本不兼容时必须阻断集成，不允许静默降级。

### 代码现状

```python
# src/integration/pipeline.py line 789-793
if (
    effective_gate != "FAIL"
    and validation_contract_version == SUPPORTED_CONTRACT_VERSION
    and not (with_validation_bridge and bridge_error)
):
    # 进入集成循环
    ...
# 版本不匹配时直接跳过循环，不抛异常

# line 577-578 (_quality_status)
if contract_version != SUPPORTED_CONTRACT_VERSION:
    return ("FAIL", "NO_GO", "contract_version_mismatch")
```

代码不抛异常，而是返回 quality_status=FAIL + go_nogo=NO_GO。

### 影响评估

两种方式都能"阻断集成输出"，差异在于：
- 设计方式（抛异常）：调用方必须处理异常，强制阻断
- 代码方式（静默返回 FAIL）：调用方如果不检查 quality_status，可能误以为没有问题

### 修复方案

**方案 A（修代码）**：在版本不匹配时显式抛出异常（需定义 ContractVersionError）。

**方案 B（改设计 — 推荐此差异用方案B）**：代码的 quality_status=FAIL 方式对 Pipeline 架构更友好（不中断 Pipeline 执行，允许报告），设计可更新为"版本不兼容时返回 FAIL + NO_GO 而非抛异常"。

### 涉及文件

- `docs/design/core-algorithms/integration/integration-algorithm.md` §2.7
- 或 `src/integration/pipeline.py`
