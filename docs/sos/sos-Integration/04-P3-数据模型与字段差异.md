# P3 数据模型与字段差异：输入输出列缺失/多余、Regime 参数未落地、信息流文档过时

**严重等级**: P3（不影响当前算法运行，但影响可追溯性和文档准确性）
**影响范围**: 数据模型文档、信息流文档、参数配置系统

---

## P3-1：输出表 `integrated_recommendation` 列不一致

### 问题描述

设计 DDL 与代码的 INTEGRATED_COLUMNS 存在多列差异——设计有但代码无、代码有但设计无。

### 详细对比

**设计 DDL 有但代码 INTEGRATED_COLUMNS 无：**

| 缺失字段 | 设计定义 | 影响 |
|----------|----------|------|
| `position_cap_ratio` | 全局仓位上限比例 0-1 | 无法追溯 Gate 下发的仓位约束 |
| `tradability_pass_ratio` | 候选方案可成交性通过率 0-1 | 无法审计候选方案执行状态 |
| `impact_cost_bps` | 候选方案冲击成本 | 无法审计冲击成本 |
| `candidate_exec_pass` | 候选方案执行约束是否通过 | 无法追溯执行约束判定 |
| `stock_name` | 股票名称 | 降低可读性 |

**代码有但设计 DDL 无：**

| 多余字段 | 代码用途 | 建议 |
|----------|----------|------|
| `t1_restriction_hit` (bool) | T+1限制标记 | 设计需补入 |
| `limit_guard_result` (str) | 涨跌停护栏结果 | 设计需补入 |
| `session_guard_result` (str) | 交易时段护栏结果 | 设计需补入 |
| `contract_version` (str) | 合约版本快照 | 设计需补入 |

### 修复方案

**方向**：双向对齐。

修复要点：
1. 代码中补齐设计要求的追溯字段（position_cap_ratio、tradability_pass_ratio、impact_cost_bps、candidate_exec_pass、stock_name）— 这些值在主循环中已可获取，只需写入 integrated_rows
2. 设计 DDL 中补入代码新增的工程字段（t1_restriction_hit、limit_guard_result、session_guard_result、contract_version）
3. 同步更新 INTEGRATED_COLUMNS 列表

### 涉及文件

- `src/integration/pipeline.py` — INTEGRATED_COLUMNS + integrated_rows 字典
- `docs/design/core-algorithms/integration/integration-data-models.md` — §4.1 DDL

---

## P3-2：输入字段读取不完整

### 问题描述

代码从 MSS/IRS/PAS 表中读取的字段与设计中定义的输入数据模型存在差异。

### 详细对比

**MSS 输入（MssInput）：**

| 设计字段 | 代码是否读取 | 说明 |
|----------|-------------|------|
| trade_date | ✅ | |
| temperature | ✅ | 代码列名 mss_temperature |
| cycle | ✅ | 代码列名 mss_cycle |
| trend | ✅ | 代码列名 mss_trend |
| position_advice | ❌ 未读取 | 设计中有但代码未使用 |
| neutrality | ❌ 未读取 | 影响中性度计算（见 P0-5） |

**IRS 输入（IrsInput）：**

| 设计字段 | 代码是否读取 | 说明 |
|----------|-------------|------|
| trade_date | ✅ | |
| industry_code | ✅ | |
| industry_name | ✅ | |
| industry_score | ✅ | 代码列名 irs_score |
| rotation_status | ❌ 未读取 | 影响方向映射（见 P0-2） |
| allocation_advice | ✅ | |
| quality_flag | ✅ | |
| sample_days | ❌ 未读取 | 设计中有，代码未使用 |
| neutrality | ❌ 未读取 | 影响中性度计算（见 P0-5） |
| — | 代码额外读取 `recommendation` | 设计 IrsInput 无此字段 |

**PAS 输入（PasInput）：**

| 设计字段 | 代码是否读取 | 说明 |
|----------|-------------|------|
| trade_date | ✅ | |
| stock_code | ✅ | |
| stock_name | ❌ 未读取 | |
| industry_code | ❌ 未读取 | 代码从 raw_index_member 查找 |
| opportunity_score | ✅ | 代码列名 pas_score |
| opportunity_grade | ✅ (optional) | |
| direction | ✅ | 代码列名 pas_direction |
| risk_reward_ratio | ✅ | |
| entry | ❌ 未读取 | 代码从 raw_daily 自行计算 |
| stop | ❌ 未读取 | 代码从 raw_daily 自行计算 |
| target | ❌ 未读取 | 代码从 raw_daily 自行计算 |
| neutrality | ❌ 未读取 | 影响中性度计算（见 P0-5） |
| — | 代码额外读取 `ts_code` | 设计无此字段 |

### 影响评估

- `rotation_status` 和 `neutrality` 的缺失直接影响算法正确性（已在 P0-2 和 P0-5 中记录）
- `position_advice`、`sample_days`、`stock_name` 的缺失不影响当前算法，但降低信息完整度
- `entry/stop/target` 的缺失意味着代码自行从 raw_daily 计算（而非从 PAS 获取），这改变了数据来源

### 修复方案

**方向**：分批补齐。

优先级1（与 P0 修复联动）：补齐 rotation_status、neutrality
优先级2（信息完整度）：补齐 stock_name、sample_days
优先级3（数据来源对齐）：确认 entry/stop/target 来源策略（从 PAS 读取 or 从 raw_daily 计算），并在设计中明确

### 涉及文件

- `src/integration/pipeline.py` — SQL 查询语句
- `docs/design/core-algorithms/integration/integration-data-models.md` — 输入模型

---

## P3-3：Regime 参数系统完全未实现

### 问题描述

设计定义了完整的 `RegimeParameters` dataclass 和 `resolve_regime_parameters()` 函数（根据 MSS 周期和市场波动动态选择 risk_on/neutral/risk_off 参数档位），代码中所有参数均硬编码。

### 设计原文

> integration-algorithm.md §11.3:
> ```python
> @dataclass
> class RegimeParameters:
>     profile_id: str                       # risk_on / neutral / risk_off
>     strong_buy_threshold: int             # >= 75
>     buy_threshold: int                    # >= 70
>     ...
>     irs_avoid_discount: float             # 默认 0.85
>     irs_overweight_boost: float           # 默认 1.05
>     position_multiplier_overweight: float # 默认 1.2
>     ...
>     td_bu_alpha_budget_ratio: float       # 冲突时 BU 可用子预算比例
>     bu_activation_sa_ratio: float         # BU 激活的 S/A 比例阈值
> ```
> 三档 profile: risk_on / neutral / risk_off

### 代码现状

代码中所有对应参数均为字面量：
- `0.85`（IRS 回避折扣）— line 895
- `75.0 / 70.0 / 50.0 / 30.0`（推荐等级阈值）— `_to_recommendation()` line 289-298
- `0.85`（温度极端仓位缩减）— line 950
- `0.90 / 35.0`（tradability/impact_cost 阈值）— line 763-764
- 无 RegimeParameters dataclass
- 无 resolve_regime_parameters() 函数
- 无 risk_on/neutral/risk_off 档位切换

### 影响评估

这是一个"设计已规划但代码尚未落地"的功能。当前使用 neutral 档位的默认值，在市场正常状态下行为与设计一致。但在以下场景会有差异：
- risk_off 时设计要求提高阈值（如 STRONG_BUY 从 75 提到 78），代码始终用 75
- risk_on 时设计要求调整 IRS 折扣（0.88 而非 0.85），代码始终用 0.85

### 修复方案

**方案 A（分阶段落地）**：

第1步（MVP）：将所有硬编码参数提取为模块级常量或配置 dict，方便后续切换
第2步（完整实现）：实现 RegimeParameters dataclass + resolve_regime_parameters()
第3步（集成）：在 run_integrated_daily() 中调用 resolve_regime_parameters()

**方案 B（改设计为"规划中"状态 — 推荐此差异用方案B）**：在设计 §11.3 标注 Regime 参数系统为"设计已定义/代码使用 neutral 默认值"，明确 MVP 阶段不实现动态切换。

### 涉及文件

- `src/integration/pipeline.py`
- `docs/design/core-algorithms/integration/integration-algorithm.md` §11.3

---

## P3-4：信息流文档 §3 组件依赖图已过时

### 问题描述

信息流文档 §3 描述的组件依赖关系仍是 OOP 架构（IntegrationController / IntegrationService / IntegrationEngine / IntegrationRepository / ScoreCalibrator / DirectionChecker / SignalConstraint / SignalGenerator / PositionCalculator），但实际代码是过程式 Pipeline（单一 `run_integrated_daily()` 函数）。

### 设计现状

> integration-information-flow.md §3:
> ```
> IntegrationController (API层)
>        │
>        ▼
> IntegrationService (服务层)
>        │
>        ├───────────────────┬───────────────────┐
>        ▼                   ▼                   ▼
> IntegrationEngine   IntegrationRepository RecommendationGen
> (集成引擎)          (数据仓库)           (推荐生成器)
>        │                   │                   │
>        ...
> ```

### 代码现状

```
run_integrated_daily()  # 单一入口函数
    ├── DuckDB 直读 MSS/IRS/PAS/Gate
    ├── _resolve_weight_plan()
    ├── 主循环（逐股计算 TD/BU 分数 + 方向 + 仓位）
    ├── _apply_recommendation_limits()
    ├── _quality_status()
    └── _persist()
```

无 class 封装，无 Service/Repository 分层。

### 影响评估

API 文档（integration-api.md v4.0.0）已在 ARCH-DECISION-001 中更新为反映 Pipeline 模式，但信息流文档的组件依赖图仍是旧架构。这会误导开发者对模块组织结构的理解。

### 修复方案

**方向**：更新信息流文档 §3，将组件依赖图替换为实际的 Pipeline 函数调用关系。

修复要点：
1. 移除 OOP 组件图
2. 替换为 Pipeline 函数调用图（`run_integrated_daily` → 内部步骤）
3. 保留数据流总览（§1）和步骤描述（§2），这些基本正确
4. 在 §3 开头注明"当前为过程式 Pipeline 架构，OOP 封装见附录"

### 涉及文件

- `docs/design/core-algorithms/integration/integration-information-flow.md` §3
