# SOS 急救方案总览：Integration 代码与核心设计差异

**创建日期**: 2026-02-27
**状态**: 待审阅
**范围**: `src/integration/pipeline.py` vs `docs/design/core-algorithms/integration/` 四份设计文档

---

## 差异全景

本次审查共发现 **19 项差异**，按严重程度分为：

| 等级 | 数量 | 含义 | 对应文件 |
|------|------|------|----------|
| P0 算法语义偏差 | 7 项 | 核心算法公式/逻辑与设计相悖，直接影响信号正确性 | `01-P0-算法语义偏差.md` |
| P1 模式语义偏差 | 3 项 | dual_verify/complementary 模式实现与设计不一致 | `02-P1-模式语义偏差.md` |
| P2 筛选排序与数据契约 | 5 项 | 推荐列表逻辑偏差、Gate 回退遗漏、异常处理差异 | `03-P2-筛选排序与数据契约.md` |
| P3 数据模型与字段差异 | 4 项 | 输入输出列缺失/多余、Regime 参数未落地、信息流文档过时 | `04-P3-数据模型与字段差异.md` |

## 修复原则

与数据篇的修复原则不同，Integration 面临的核心决策是：

1. **ARCH-DECISION-001 已选"文档对齐代码"** — API 文档已按此执行，但 algorithm/data-models/information-flow 三份文档尚未跟进
2. **部分差异是"设计已定义但代码合理简化"** — 如 Regime 参数系统、三系统 neutrality 加权，可视为 MVP 简化
3. **部分差异是"代码确实偏离了设计意图"** — 如 strength_factor 未应用、IRS 方向来源错误，需要明确是修代码还是改设计
4. **决策路径**：每项差异需先判定"以谁为准"，再执行对齐

### 建议的两轮处理

**第一轮：确认权威口径** — 逐项判定"代码对 / 设计对 / 双方都需调整"
**第二轮：执行对齐** — 按判定结果修代码或改文档

## 影响链分析

```
Integration 算法偏差
    ↓
  final_score 计算有误（strength_factor 缺失、IRS 方向错误、仓位乘子缺失）
    ↓
  recommendation / position_size 准确性下降
    ↓
  交易信号质量不可信
    ↓
  推荐列表（Top 20）可能排序/筛选错误

但注意：Integration 的输入来自 MSS/IRS/PAS 三系统，
    如果上游系统本身已经修复（数据篇/MSS篇/PAS篇），
    Integration 的偏差会被放大或缓解。
```

## 已确认一致的部分（无需修改）

- ✅ BASELINE_WEIGHTS = 1/3 × 3
- ✅ MAX_MODULE_WEIGHT = 0.60
- ✅ 推荐等级映射阈值（75/70/50/30）与 STRONG_BUY 周期条件
- ✅ MSS cycle=unknown → 降级为 HOLD
- ✅ Gate=FAIL → 阻断集成
- ✅ 候选方案 exec_pass/tradability/impact_cost 检查（threshold 0.90/35.0）
- ✅ TD/BU 周期仓位上限表（upper bound 一致）
- ✅ 每日最多20只、每行业最多5只硬约束
- ✅ IntegrationRunResult 字段与 API 文档一致
- ✅ contract_version = "nc-v1" 检查
- ✅ 方向判定公式 avg > 0.3 → bullish, < -0.3 → bearish

## 文件清单

| 文件 | 内容 |
|------|------|
| `00-总览.md` | 本文件 |
| `01-P0-算法语义偏差.md` | 7 项核心算法偏差的详细诊断与修复方案 |
| `02-P1-模式语义偏差.md` | 3 项双模式/组合模式偏差的详细诊断与修复方案 |
| `03-P2-筛选排序与数据契约.md` | 5 项筛选排序/Gate回退/异常处理偏差的详细诊断与修复方案 |
| `04-P3-数据模型与字段差异.md` | 4 项数据模型/Regime参数/信息流文档偏差的详细诊断与修复方案 |
