# Trading 模块 — 风险评估

---

## 1. 总体风险定级：🔴 极高

Trading 模块是**资金直接接触面**，所有偏差均有实际亏损后果。当前三角脱节
（设计 ↔ Trading 代码 ↔ Backtest 代码）意味着：

1. **回测绩效不可信** — Backtest 和 Trading 信号集、成交模型、费用基准全面不同，
   回测结果无法预测实盘表现
2. **风控存在结构性缺口** — 6 项设计风控仅实现 3 项，行业集中度双缺失
3. **止损机制完全不存在** — 无论涨跌，T+1 一律全卖，无下行保护

---

## 2. 级联影响分析

### 2.1 成交模型缺失 → 滑点黑洞 (T-09)

```
Trading 全额成交
  → 无 fill_probability / impact_cost 估算
    → 小盘股 / 低流动性票照买不误
      → 实盘冲击成本可达 2-5%（L3 级别 35bps 仅为理论下限）
        → 单票亏损可能超预期 3-5 倍
```

**影响半径**: 每一笔买入交易  
**最坏场景**: 流动性枯竭标的买入后无法按预期价格卖出

### 2.2 信号字段缺失 → 风控链断裂 (T-05)

```
缺 stop / target
  → 无法计算止损止盈价
    → T-10 止损/止盈逻辑无从实现

缺 neutrality
  → v2.0 验证完全跳过
    → 高冲突信号（neutrality>0.6）获得全额仓位
      → 持仓集中在低质量信号上

缺 opportunity_grade
  → D 级信号不被过滤
    → 低质量交易占比上升
```

**影响半径**: 整个信号消费链（过滤 → 验证 → 下单 → 持仓管理）

### 2.3 回测-实盘不一致 → 决策失真 (B-01 + B-02 + B-06)

```
信号过滤三方各异
  + 费用计算基准不同
    + 成交模型不对称
      → 回测的收益曲线与实盘交易的实际表现之间
        存在系统性且方向不可预测的偏差
```

**具体偏差向量**:
- Backtest 费用更高（有分档+冲击）→ 回测利润偏低
- Backtest 部分成交 → 回测成交量偏少
- 但 Backtest 信号集更宽（STRONG_BUY/BUY 白名单不检查 score/rr）→ 回测可能包含实盘不会执行的票

这些偏差方向不一致，导致总偏差不可简单预估。

### 2.4 风控缺口 → 集中度风险 (T-08)

```
行业集中度无检查 (双缺失)
  + 单股仓位上限不完整 (Trading)
    → 极端情况: 全部资金集中在同一行业 1-2 只票
      → 单一行业利空 → 组合亏损远超预期
```

---

## 3. 问题优先级矩阵

### P0 致命 — 直接影响资金安全（重建时必须首先解决）

| ID | 问题 | 风险 |
|----|------|------|
| T-09 | 成交模型缺失 | 滑点黑洞，低流动性票无保护 |
| T-10 | 止损/止盈/回撤全缺 | 无下行保护 |
| T-05 | 信号字段 10/18 | 风控链断裂 |
| T-07 | v2.0 验证缺失 | 高冲突信号全额入场 |
| T-08 | 风控 3/6 | 集中度风险敞口 |
| T-04 | t1_frozen 未建 | T+1 逻辑仅靠内联字段 |
| B-07 | T+1 无条件全卖 | 策略本质错误 |

### P1 严重 — 数据完整性与系统一致性

| ID | 问题 | 风险 |
|----|------|------|
| T-02 | trade_records 28→21 | 成交记录不完整 |
| T-03 | positions 20→12 | 持仓追溯缺失 |
| T-06 | 信号过滤偏离 | 交易信号集与设计不符 |
| T-11 | 状态机 6→2 | 无法追踪中间态 |
| T-14 | Gate 模型差异 | 门禁逻辑不透明 |
| T-15 | 存储模型分歧 | positions 语义不一致 |
| B-01 | 成交模型不对称 | 回测 ≠ 实盘 |
| B-02 | 过滤三方各异 | 回测信号集 ≠ 实盘 |
| B-03 | 风控交叉缺失 | 双方各缺不同检查 |
| B-06 | 费用不一致 | 回测成本 ≠ 实盘 |

### P2 中度 — 数据规范性

| ID | 问题 |
|----|------|
| T-12 | 枚举硬编码 |
| T-13 | risk_events 无设计 |
| T-16 | RejectReason 命名冲突 |
| B-04 | Backtest 字段不写入 |
| B-05 | RejectReason 扩展未同步 |
| B-08 | 绝对阈值 vs 百分位 |
| B-09 | fill_ratio 公式不完整 |
| B-10 | 超额实现未同步 |

### P3 轻度

| ID | 问题 |
|----|------|
| T-01 | 文档实现状态过时 |

---

## 4. 重建方向判定

原始急救方案提出三个方向：A（文档对齐代码）、B（代码对齐设计）、C（双向收敛）。

**重建采用 AD-01 原则：设计为权威**，即方向 B 为主体：

- 所有 P0 问题按设计标准重建，不保留代码中的简化实现
- Backtest 的合理超额实现（一字板、流动性枯竭）纳入设计文档后双方统一实现
- 代码独有字段（`t1_restriction_hit` 等）经审核后吸收入设计
- T+1 无条件全卖必须替换为设计的条件平仓体系
- Trading 和 Backtest 共享核心模块: `execution_model`, `fee_calculator`, `signal_filter`, `risk_checker`

**不允许**: Trading 和 Backtest 各自维护独立的成交/费用/过滤逻辑。
重建后两者必须通过共享服务层保持行为一致。
