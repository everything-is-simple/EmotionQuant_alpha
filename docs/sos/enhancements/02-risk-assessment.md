# Enhancements 模块 — 风险评估

---

## 1. 总体风险定级：🟠 高

Enhancements 是系统的**运维骨架**（调度、监控、质量守卫、测试基础设施）。
当前核心运维能力严重缺失：监控仅占位、Qlib 路径未建、冻结检查方向偏离。

---

## 2. 致命问题影响分析

### E-11 Qlib 适配层缺失 — 架构裁决级问题

AD-03 裁决 Qlib 为唯一回测引擎，但代码中零 Qlib 代码，回测由本地向量化引擎完成。

**两条路径**:
- **路径 A**: 实现 Qlib 适配层（to_qlib_signal + from_qlib_result），保留本地引擎作为 fallback
- **路径 B**: 修订 AD-03，承认本地引擎为主引擎，Qlib 作为可选增强

**影响**: 路径 A 需要大量工程投入（Qlib 环境搭建 + 信号格式转换 + 结果回转）。
路径 B 需要更新路线图中所有引用 Qlib 的部分。

**建议**: 重建时需在 R0 阶段做出明确裁决并记录。

### E-14 监控仅占位 — 生产环境不可用

无监控 = 无法感知系统异常。当前散落的监控能力（quality_gate, validation gate, scheduler log）
没有统一接口，无告警分级，无升级机制，无通知路径。

**影响**:
- 数据采集失败无告警 → 下游算法用过期数据
- 交易下单失败无告警 → 资金风险
- 任务连续失败无熔断 → 雪崩

### E-10 SHA256 冻结检查方向偏离

设计意图是守卫核心设计文档不被意外修改（文档变更检测），
代码做的是确保代码可以追溯到设计文档（代码溯源检查）。

两者互补但不等价。在重建过程中设计文档会频繁变更，SHA256 守卫反而可能成为阻碍。
建议重建完成后再锚定。

### E-03 validate_token() 缺失

用户首次使用系统时 token 配置错误无法快速定位。
影响范围小但用户体验差，修复成本低。

### E-07 金丝雀 parquet 缺失

SimulatedTuShareClient 提供了等价的测试覆盖，但数据生成逻辑嵌入被测代码中，
存在"代码改了模拟数据跟着变"的风险。

---

## 3. 中度问题优先级

| ID | 问题 | 影响 | 优先级 |
|----|------|------|--------|
| E-04 | 重试无退避 | 可能触发 API 限流 | P1 |
| E-06 | error_manifest 格式不统一 | 无法与监控 P0/P1/P2 体系对接 | P1 |
| E-09 | C 组等权持有缺失 | 缺少最基础基准 | P1 |
| E-12 | DAG 编排不完整 | 无并行、无完整步骤链 | P1 |
| E-13 | 调度重试策略偏离 | 固定 5 分钟过长 | P1 |
| E-05 | 异常类单一 | 无法精细化错误处理 | P2 |
| E-15 | 目录结构偏差 | 文档与实际不匹配 | P2 |

---

## 4. 重建方向

**AD-01 设计为权威**，但 enhancements 有特殊性：
- 部分代码实现比设计更务实（argparse 替代 Typer、per-module error_manifest 替代全局单文件）
- 这些合理偏差应通过修订设计文档来认可

**设计为准的硬性项**:
- Qlib 适配层（或明确裁决变更 AD-03）
- 监控告警完整实现
- SHA256 冻结检查
- validate_token() 预检
- 金丝雀 parquet 数据包

**代码为准（修订设计）的项**:
- argparse 替代 Typer ← 已更务实
- per-module artifacts 路径 ← 已更实用
- `tests/unit/` 体系 ← 已成事实
- 额外 12 个子命令 ← 功能更丰富
