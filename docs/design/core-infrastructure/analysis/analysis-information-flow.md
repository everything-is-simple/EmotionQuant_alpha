# Analysis 信息流

**版本**: v3.1.4（重构版）
**最后更新**: 2026-02-12
**状态**: 设计完成（代码未落地）

---

## 1. 数据流总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Analysis 信息流架构图                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  L3 算法输出层（输入）                                                        │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                     │
│  │ mss_panorama │   │irs_industry  │   │ stock_pas    │                     │
│  │              │   │   _daily     │   │   _daily     │                     │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                     │
│         │                  │                  │                              │
│         └──────────────────┼──────────────────┘                              │
│                            │                                                 │
│                            ▼                                                 │
│                 ┌──────────────────────┐                                     │
│                 │ integrated_          │                                     │
│                 │ recommendation       │                                     │
│                 └──────────┬───────────┘                                     │
│                            │                                                 │
│  L3 运行时数据（输入）      │                                                 │
│  ┌──────────────┐         │          ┌──────────────┐                       │
│  │ trade_       │─────────┼──────────│  positions   │                       │
│  │   records    │         │          └──────┬───────┘                       │
│  └──────────────┘         │                 │                               │
│                           │                 │                               │
│  ┌──────────────┐         │                 │                               │
│  │ backtest_    │─────────┘                 │                               │
│  │   results    │                           │                               │
│  └──────────────┘                           │                               │
│                                             │                               │
│         ┌───────────────────────────────────┘                               │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Analysis Engine                                   │   │
│  │                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │ Performance  │  │   Signal     │  │    Risk      │               │   │
│  │  │  Analyzer    │  │  Attributor  │  │  Reporter    │               │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘               │   │
│  │         │                 │                 │                        │   │
│  │         └─────────────────┼─────────────────┘                        │   │
│  │                           │                                          │   │
│  │                           ▼                                          │   │
│  │               ┌──────────────────────┐                               │   │
│  │               │    Report Writer     │                               │   │
│  │               └──────────┬───────────┘                               │   │
│  │                          │                                           │   │
│  └──────────────────────────┼───────────────────────────────────────────┘   │
│                             │                                               │
│         ┌───────────────────┼───────────────────┐                          │
│         │                   │                   │                          │
│         ▼                   ▼                   ▼                          │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                    │
│  │ daily_       │   │ performance_ │   │  signal_     │                    │
│  │   report     │   │   metrics    │   │  attribution │                    │
│  └──────────────┘   └──────────────┘   └──────────────┘                    │
│                                                                             │
│  文件输出层                                                                  │
│  ┌──────────────┐   ┌──────────────┐                                       │
│  │ Markdown     │   │    CSV       │                                       │
│  │ Reports      │   │   Exports    │                                       │
│  └──────────────┘   └──────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**说明**：
- 回测分析场景使用 `backtest_trade_records` 与 `backtest_results.equity_curve`
- 报告默认落盘 `.reports/analysis/`，文件名使用 `{YYYYMMDD_HHMMSS}` 时间戳

---

## 2. 日报生成流程

### 2.1 完整流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      日报生成流程                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  触发时机: 收盘后 (15:30+)                                                │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────┐                            │
│  │  1. 获取市场概况                         │                            │
│  │     mss = repo.get_mss_panorama(date)   │                            │
│  │     → temperature, cycle, trend         │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  2. 获取行业轮动                         │                            │
│  │     irs = repo.get_irs_industry_daily() │                            │
│  │     → top5, in_count, out_count         │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  3. 获取信号与交易                       │                            │
│  │     signals = repo.get_integrated_rec() │                            │
│  │     is_backtest = repo.is_backtest_ctx()│                            │
│  │     trades = repo.get_trade_records()   │                            │
│  │         if not is_backtest else         │                            │
│  │         repo.get_backtest_trade_records()│                           │
│  │     → signal_count, filled, rejected    │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  4. 计算绩效指标                         │                            │
│  │     metrics = analyzer.compute_metrics( │                            │
│  │       start_date, end_date,             │                            │
│  │       equity_curve, trades)             │                            │
│  │     → return, drawdown, sharpe, win_rate│                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  5. 计算信号归因                         │                            │
│  │     attr = attributor.attribute_signals()│                           │
│  │     → mss/irs/pas_attribution           │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  6. 分析风险分布                         │                            │
│  │     risk = risk_reporter.analyze_risk() │                            │
│  │     → low/medium/high_pct               │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  7. 构建日报数据                         │                            │
│  │     report_data = DailyReportData(...)  │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  8. 渲染Markdown                         │                            │
│  │     md = report_writer.render_markdown() │                           │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  9. 落库与导出                           │                            │
│  │     repo.save_daily_report(report_data) │                            │
│  │     report_writer.export_to_file(md)    │                            │
│  └─────────────────────────────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

> 说明：分析层成交统计默认使用 `trade_records`（交易执行）。回测分析场景使用
> `backtest_trade_records`，绩效计算使用 `backtest_results.equity_curve`。

### 2.2 数据聚合时序

```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│Scheduler│ │  Repo   │ │Analyzer │ │Attributor││RiskRpt  │ │ReportWrt│
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │           │           │           │           │
     │ get_mss   │           │           │           │           │
     │──────────>│           │           │           │           │
     │           │           │           │           │           │
     │ get_irs   │           │           │           │           │
     │──────────>│           │           │           │           │
     │           │           │           │           │           │
     │ get_recs  │           │           │           │           │
     │──────────>│           │           │           │           │
     │           │           │           │           │           │
     │ compute   │           │           │           │           │
     │──────────────────────>│           │           │           │
     │           │           │           │           │           │
     │ attribute │           │           │           │           │
     │────────────────────────────────────>│         │           │
     │           │           │           │           │           │
     │ analyze_risk          │           │           │           │
     │──────────────────────────────────────────────>│           │
     │           │           │           │           │           │
     │ generate_report                               │           │
     │──────────────────────────────────────────────────────────>│
     │           │           │           │           │           │
     │ save & export                                             │
     │<──────────────────────────────────────────────────────────│
```

---

## 3. 绩效计算流程

### 3.1 指标计算链

```
equity_curve (净值序列)
     │
     ├──────────────────────────────────────┐
     │                                      │
     ▼                                      ▼
┌──────────────┐                   ┌──────────────┐
│ 日收益率计算  │                   │ 最大回撤计算  │
│              │                   │              │
│ r_t = e_t /  │                   │ peak = max   │
│       e_{t-1}│                   │ dd = (e-peak)│
│       - 1    │                   │      / peak  │
└──────┬───────┘                   └──────┬───────┘
       │                                  │
       ▼                                  ▼
┌──────────────────────────────────────────────────┐
│                 风险调整收益计算                   │
│                                                   │
│  daily_rf = risk_free_rate / 252                │
│  sharpe = sqrt(252) × (mean(r)-daily_rf)/std(r) │
│  sortino = sqrt(252) × (mean(r)-daily_rf)/sqrt(mean(min(r-daily_rf,0)^2)) │
│  calmar = annual_return / abs(max_dd)           │
└──────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│                 交易统计计算                       │
│                                                   │
│  win_rate = 盈利交易 / 总交易                     │
│  profit_factor = 总盈利 / 总亏损                  │
│  avg_holding = mean(持仓天数)                     │
└──────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│              PerformanceMetrics                   │
└──────────────────────────────────────────────────┘
```

---

## 4. 信号归因流程

### 4.1 归因计算

```
integrated_recommendation + trade_records (实盘)
backtest_trade_records (回测分析)
     │
     ▼
┌─────────────────────────────────────────┐
│  1. 匹配推荐与成交                       │
│                                          │
│  for rec in recommendations:             │
│      trade = find_trade(rec.stock_code)  │
│      if trade and trade.status == filled:│
│          matched.append((rec, trade))    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  2. 计算盈亏贡献                         │
│                                          │
│  for rec, trade in matched:             │
│      execution_deviation =              │
│          (trade.price - rec.entry)      │
│          / rec.entry                    │
│      # 注：execution_deviation 为执行偏差，│
│      # 非真实交易盈亏                    │
│                                          │
│      mss_contrib = rec.mss_score * execution_deviation │
│      irs_contrib = rec.irs_score * execution_deviation │
│      pas_contrib = rec.pas_score * execution_deviation │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  3. 汇总归因结果                         │
│                                          │
│  mss_attribution = mean(mss_contrib)    │
│  irs_attribution = mean(irs_contrib)    │
│  pas_attribution = mean(pas_contrib)    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  SignalAttribution                       │
│  - mss_attribution                       │
│  - irs_attribution                       │
│  - pas_attribution                       │
│  - sample_count                          │
└─────────────────────────────────────────┘
```

---

## 5. 数据依赖关系

### 5.1 输入依赖

```
                 ┌─────────────────────────────────────┐
                 │           L3 算法输出层              │
                 └─────────────────┬───────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  mss_panorama   │     │irs_industry_daily│    │integrated_      │
│                 │     │                 │     │  recommendation │
│ 日报市场概况     │     │ 日报行业轮动     │     │ 信号有效性       │
└─────────────────┘     └─────────────────┘     │ 信号归因         │
                                                └─────────────────┘


                 ┌─────────────────────────────────────┐
                 │           L3 运行时数据              │
                 └─────────────────┬───────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ trade_records / │     │   positions     │     │backtest_results │
│ backtest_trade_ │     │                 │     │   (回测)         │
│ records         │     │ 集中度风险       │     │ 绩效指标         │
│ (实盘/回测)      │     │                 │     │                 │
│ 交易统计/信号归因 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

> 注：回测分析时以 `backtest_trade_records` 参与交易统计与归因。

### 5.2 输出关系

```
┌─────────────────────────────────────────────────────────────┐
│                    Analysis Engine 输出                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  daily_report (L4)                                   │    │
│  │  - 日度分析摘要                                       │    │
│  │  - 市场/行业/信号/绩效/风险                           │    │
│  └───────────────────────────┬─────────────────────────┘    │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  performance_metrics (L4)                            │    │
│  │  - 阶段性绩效指标                                     │    │
│  │  - 收益/风险/风险调整收益/交易统计                    │    │
│  └───────────────────────────┬─────────────────────────┘    │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  signal_attribution (L4)                             │    │
│  │  - MSS/IRS/PAS贡献度                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
└──────────────────────────────┬──────────────────────────────┘
                               │
               ┌───────────────┴───────────────┐
               │                               │
               ▼                               ▼
      ┌─────────────────┐             ┌─────────────────┐
      │ Markdown Reports │            │   CSV Exports    │
      │                 │             │                 │
      │ daily_report_   │             │ performance_    │
      │ 20260131_153000 │             │ 20260131_153000 │
      │      .md        │             │      .csv       │
      └─────────────────┘             └─────────────────┘
```

> 文件输出：默认落盘 `.reports/analysis/`，命名统一 `{YYYYMMDD_HHMMSS}`。

---

## 6. 执行时序

### 6.1 日度执行

| 时间 | 任务 | 输出 |
|------|------|------|
| 15:30 | 等待数据就绪 | - |
| 15:35 | 计算绩效指标 | performance_metrics |
| 15:40 | 计算信号归因 | signal_attribution |
| 15:45 | 生成日报 | daily_report |
| 15:50 | 导出文件 | *.md, *.csv |

### 6.2 周度/月度执行

```
周报触发（周五收盘后）
     │
     ▼
┌─────────────────────────────────────────┐
│  1. 汇总本周daily_report                 │
│  2. 计算周度performance_metrics          │
│  3. 生成weekly_report.md                │
└─────────────────────────────────────────┘

月报触发（月末收盘后）
     │
     ▼
┌─────────────────────────────────────────┐
│  1. 汇总本月数据                         │
│  2. 计算月度绩效                         │
│  3. 信号有效性分析                       │
│  4. 生成monthly_report.md               │
│  5. 归档至 .reports/archive/analysis/{YYYYMM}/  │
└─────────────────────────────────────────┘
```

---

## 7. 异常处理

### 7.1 数据缺失处理

| 缺失数据 | 处理策略 |
|----------|----------|
| mss_panorama | 使用前一日数据，标记degraded |
| trade_records | 信号统计置零 |
| backtest_trade_records | 回测统计置零 |
| backtest_results | 跳过绩效计算（回测场景） |
| equity_curve | 跳过绩效计算 |
| integrated_recommendation | 跳过归因计算 |
| positions | 跳过集中度统计 |

### 7.2 计算异常处理

| 异常 | 处理 |
|------|------|
| 除零（std=0） | sharpe/sortino 置 0 |
| 无交易 | win_rate/profit_factor 置 0 |
| 无亏损交易 | profit_factor 置 +inf |
| max_drawdown=0 | calmar 置 0 |
| 净值为负 | 跳过该日计算 |

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.1.4 | 2026-02-12 | 路径整理：月报归档目录口径由 `.archive/analysis/` 统一为 `.reports/archive/analysis/` |
| v3.1.3 | 2026-02-09 | 修复 R21：§2.1 日报流程补齐实盘/回测成交分支并显式 `compute_metrics(equity_curve, trades)` 输入；§4.1 术语统一为 `execution_deviation` |
| v3.1.2 | 2026-02-08 | 修复 R11：Sortino 流程符号改为下行偏差 RMS，避免与 Backtest 口径歧义 |
| v3.1.1 | 2026-02-08 | 修复 R10：风险调整收益流程补入 `risk_free_rate` 日化项，与 Backtest/Analysis 公式统一 |
| v3.1.0 | 2026-02-04 | 对齐回测依赖、输出规范与异常口径 |
| v3.0.0 | 2026-01-31 | 重构版：统一信息流描述 |
| v2.1.0 | 2026-01-23 | 增加信号归因流程 |
| v2.0.0 | 2026-01-20 | 初始版本 |

---

**关联文档**：
- 核心算法：[analysis-algorithm.md](./analysis-algorithm.md)
- 数据模型：[analysis-data-models.md](./analysis-data-models.md)
- API接口：[analysis-api.md](./analysis-api.md)


