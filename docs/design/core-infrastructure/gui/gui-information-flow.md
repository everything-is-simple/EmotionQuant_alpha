# GUI 信息流

**版本**: v3.2.0（重构版）
**最后更新**: 2026-02-14
**状态**: 设计完成（闭环口径补齐；代码待实现）

---

## 1. 数据流总览

**运行形态**：Streamlit 为正式 GUI；Jupyter 仅用于内部原型/探索（不作为生产界面）。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          GUI 信息流架构图                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  L3/L4 数据层（输入）                                                         │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                     │
│  │ mss_panorama │   │irs_industry  │   │ stock_pas    │                     │
│  │ (温度/周期)  │   │   _daily     │   │   _daily     │                     │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                     │
│         │                  │                  │                              │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                     │
│  │ integrated_  │   │ trade_       │   │ positions    │                     │
│  │recommendation│   │   records    │   │              │                     │
│  └──────┬───────┘   └──────┬───────┘   └──────┬───────┘                     │
│         │                  │                  │                              │
│  ┌──────────────┐   ┌──────────────┐                                        │
│  │backtest_     │   │ daily_       │                                        │
│  │  results     │   │   report     │                                        │
│  └──────┬───────┘   └──────┬───────┘                                        │
│         │                  │                                                 │
│         └──────────────────┼──────────────────────────────────┐              │
│                            │                                  │              │
│                            ▼                                  │              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DataService                                     │    │
│  │                                                                      │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐     │    │
│  │  │DataRepo    │  │CacheService│  │FilterSvc   │  │FormatterSvc│     │    │
│  │  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘     │    │
│  │        │               │               │               │             │    │
│  │        └───────────────┼───────────────┼───────────────┘             │    │
│  │                        │               │                             │    │
│  └────────────────────────┼───────────────┼─────────────────────────────┘    │
│                           │               │                                  │
│                           ▼               ▼                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Page Controllers                             │    │
│  │                                                                      │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐        │    │
│  │  │Dashboard│ │  MSS    │ │  IRS    │ │  PAS    │ │Integrated│       │    │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘        │    │
│  │       │           │           │           │           │              │    │
│  │  ┌─────────┐ ┌─────────┐                                            │    │
│  │  │ Trading │ │Analysis │                                            │    │
│  │  └────┬────┘ └────┬────┘                                            │    │
│  │       │           │                                                  │    │
│  └───────┼───────────┼──────────────────────────────────────────────────┘    │
│          │           │                                                       │
│          ▼           ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Components                                   │    │
│  │                                                                      │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐     │    │
│  │  │Temperature │  │ CycleBadge │  │IndustryRank│  │Recommendation│   │    │
│  │  │   Card     │  │            │  │   Table    │  │    Table    │    │    │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘     │    │
│  │                                                                      │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐                     │    │
│  │  │StockSignal │  │RiskOverview│  │ChartWidget │                     │    │
│  │  │   Table    │  │            │  │            │                     │    │
│  │  └────────────┘  └────────────┘  └────────────┘                     │    │
│  │                                                                      │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  输出层                                                                       │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐                     │
│  │  Browser UI  │   │  CSV Export  │   │  MD Export   │                     │
│  └──────────────┘   └──────────────┘   └──────────────┘                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 1.1 CP-09 最小可运行闭环（P0）

```
GUI 启动
  │
  ▼
DataService.run_minimal(trade_date)
  │
  ├── get_dashboard_data(trade_date, top_n)
  ├── get_integrated_page_data(trade_date, filters, page=1)
  ├── render Dashboard
  └── render IntegratedPage
  │
  ▼
输出: GuiRunResult
  - rendered_pages=["dashboard","integrated"]
  - data_state
  - freshness_summary
```

---

## 2. 页面数据流

### 2.1 Dashboard页面流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Dashboard 数据流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  用户访问 Dashboard                                                       │
│     │                                                                    │
│     ▼                                                                    │
│  ┌─────────────────────────────────────────┐                            │
│  │  1. DataService.get_dashboard_data()    │                            │
│  │     - trade_date: 最新交易日             │                            │
│  │     - top_n: 10                         │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  2. 并行查询数据                         │                            │
│  │     ├── repo.get_mss_panorama()         │                            │
│  │     ├── repo.get_irs_industry_daily()   │                            │
│  │     └── repo.get_integrated_recommendation()                         │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  3. 数据转换                             │                            │
│  │     - format_temperature() → 颜色/标签   │                            │
│  │     - format_cycle() → 中文标签          │                            │
│  │     - format_integration_mode() → 模式徽标│                            │
│  │     - resolve_filter_config() → 生效阈值  │                            │
│  │     - apply_filters() → 筛选推荐         │                            │
│  │     - apply_sort() → 按评分排序          │                            │
│  │     - get_freshness_meta() → 新鲜度      │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  4. 构建 DashboardData                   │                            │
│  │     - temperature_card                  │                            │
│  │     - cycle_badge                       │                            │
│  │     - integration_mode_badge            │                            │
│  │     - active_filter_badges              │                            │
│  │     - freshness_badge/data_asof         │                            │
│  │     - top_recommendations               │                            │
│  │     - top_industries                    │                            │
│  └────────────────┬────────────────────────┘                            │
│                   │                                                      │
│                   ▼                                                      │
│  ┌─────────────────────────────────────────┐                            │
│  │  5. 渲染组件                             │                            │
│  │     - TemperatureCard                   │                            │
│  │     - CycleBadge                        │                            │
│  │     - RecommendationTable               │                            │
│  │     - IndustryRankTable                 │                            │
│  └─────────────────────────────────────────┘                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 带分页的页面流程（PAS/集成推荐）

```
用户访问 PAS 页面
     │
     ▼
┌─────────────────────────────────────────┐
│  1. 解析请求参数                         │
│     - trade_date: 当前日期              │
│     - page: 1                           │
│     - page_size: 50                     │
│     - filters: (从UI读取)               │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  2. 检查缓存                             │
│     cache_key = build_cache_key(        │
│         "stock_pas_daily",              │
│         trade_date,                     │
│         filters                         │
│     )                                   │
│     if cache_hit: return cached_data    │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  3. 查询数据                             │
│     stocks = repo.get_stock_pas_daily()  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  4. 应用过滤                             │
│     filtered = apply_filters(stocks, [   │
│         {score >= min_score},           │
│         {opportunity_grade >= min_grade} │
│     ])                                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  5. 应用排序                             │
│     sorted = apply_sort(filtered, [     │
│         "opportunity_score DESC",       │
│         "neutrality ASC"                │
│     ])                                  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  6. 分页                                 │
│     paged, pagination = paginate(       │
│         sorted, page, page_size         │
│     )                                   │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  7. 数据转换                             │
│     for stock in paged:                 │
│         format_opportunity_grade()      │
│         format_direction()              │
│         format_neutrality()             │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  8. 设置缓存                             │
│     set_cached(cache_key, result, ttl)  │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  9. 返回 PasPageData                     │
│     - stocks: 当前页数据                 │
│     - pagination: 分页信息               │
└─────────────────────────────────────────┘
```

---

## 3. 组件数据流

### 3.1 温度卡片数据流

```
mss_panorama.temperature (65.5)
     │
     ▼
┌────────────────────────────────┐
│  FormatterService              │
│  format_temperature(65.5)      │
│                                │
│  - 65.5 > 80? No              │
│  - 65.5 >= 45? Yes → orange   │
│  - (若未命中上支) >= 30? → cyan │
│  - (若仍未命中) < 30 → blue     │
└────────────────────────────────┘
     │
     ▼
TemperatureCardData(
    value=65.5,
    color="orange",
    label="中性"
)
     │
     ▼
┌────────────────────────────────┐
│  TemperatureCard Component     │
│  ┌─────────────────────┐       │
│  │    65.5             │       │
│  │    [中性]           │       │
│  │    背景色: orange   │       │
│  └─────────────────────┘       │
└────────────────────────────────┘
```

### 3.2 推荐表格数据流

```
integrated_recommendation (原始数据)
     │
     ▼
┌────────────────────────────────┐
│  读取阈值: resolve_filter_config│
│  过滤: final_score >= cfg.min  │
│  排序: final_score DESC        │
│  分页: top_n = 10              │
└────────────────────────────────┘
     │
     ▼
┌────────────────────────────────┐
│  逐行转换                       │
│  for row in data:              │
│    - recommendation_color      │
│    - direction_icon            │
│    - integration_mode_badge    │
│    - position_size_percent     │
│    - reason_panel(Analysis L4) │
└────────────────────────────────┘
     │
     ▼
List[RecommendationItem]
     │
     ▼
┌────────────────────────────────┐
│  RecommendationTable Component │
│  ┌──────────────────────────┐  │
│  │ 排名 │ 股票 │ 评分 │ 仓位 │  │
│  │  1   │ XXX  │ 85  │ 8%  │  │
│  │  2   │ YYY  │ 82  │ 6%  │  │
│  └──────────────────────────┘  │
└────────────────────────────────┘
```

### 3.3 推荐原因联动流（P2）

```
用户点击推荐项(stock_code)
     │
     ▼
DataService.get_recommendation_reason_panel(stock_code, trade_date)
     │
     ├── read signal_attribution (L4)
     ├── read daily_report.risk_summary (L4)
     └── read live_backtest_deviation (L4)
     │
     ▼
RecommendationReasonPanel
     │
     ▼
Integrated 页面侧边栏展示:
  - MSS/IRS/PAS attribution
  - risk_turning_point
  - deviation_hint
```

---

## 4. 页面交互流程

### 4.1 页面导航

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        页面导航流程                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                    ┌─────────────┐                                       │
│                    │  Dashboard  │                                       │
│                    └──────┬──────┘                                       │
│                           │                                              │
│         ┌─────────────────┼─────────────────┐                           │
│         │                 │                 │                           │
│         ▼                 ▼                 ▼                           │
│    ┌─────────┐       ┌─────────┐       ┌─────────┐                      │
│    │   MSS   │       │   IRS   │       │   PAS   │                      │
│    └─────────┘       └─────────┘       └────┬────┘                      │
│                                             │                           │
│                                             ▼                           │
│                                    ┌─────────────────┐                  │
│                                    │ Integrated      │                  │
│                                    │ Recommendation  │                  │
│                                    └────────┬────────┘                  │
│                                             │                           │
│                                             ▼                           │
│                                    ┌─────────────────┐                  │
│                                    │    Trading      │                  │
│                                    └────────┬────────┘                  │
│                                             │                           │
│                                             ▼                           │
│                                    ┌─────────────────┐                  │
│                                    │    Analysis     │                  │
│                                    └─────────────────┘                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 用户交互序列

```
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│  User   │ │   UI    │ │DataSvc  │ │ Cache   │ │ Repo    │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │           │           │           │
     │ 访问页面  │           │           │           │
     │──────────>│           │           │           │
     │           │           │           │           │
     │           │ getData   │           │           │
     │           │──────────>│           │           │
     │           │           │           │           │
     │           │           │ check     │           │
     │           │           │──────────>│           │
     │           │           │           │           │
     │           │           │   miss    │           │
     │           │           │<──────────│           │
     │           │           │           │           │
     │           │           │ query     │           │
     │           │           │──────────────────────>│
     │           │           │           │           │
     │           │           │   data    │           │
     │           │           │<──────────────────────│
     │           │           │           │           │
     │           │           │ set_cache │           │
     │           │           │──────────>│           │
     │           │           │           │           │
     │           │ formatted │           │           │
     │           │<──────────│           │           │
     │           │           │           │           │
     │ 渲染页面  │           │           │           │
     │<──────────│           │           │           │
```

---

## 5. 导出流程

### 5.1 CSV导出流程

```
用户点击 [导出CSV]
     │
     ▼
┌─────────────────────────────────────────┐
│  1. 获取当前筛选条件                     │
│     filters = get_current_filters()     │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  2. 查询完整数据（不分页）               │
│     data = data_service.get_all(        │
│         trade_date, filters             │
│     )                                   │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  3. 构建列配置                           │
│     columns = [                         │
│         {"field": "stock_code", ...},   │
│         {"field": "final_score", ...}   │
│     ]                                   │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  4. 导出文件                             │
│     path = export_to_csv(               │
│         data, columns,                  │
│         "recommendations"               │
│     )                                   │
│     → .reports/gui/recommendations_20260131_153000.csv│
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  5. 触发下载                             │
│     download_file(path)                 │
└─────────────────────────────────────────┘
```

---

## 6. 刷新策略

### 6.1 刷新时机

| 页面 | 刷新策略 | 刷新间隔 | 新鲜度展示 |
|------|----------|----------|------------|
| Dashboard | 自动刷新 | 60秒 | fresh/stale_soon/stale |
| MSS | 日更新 | 盘后刷新 | fresh/stale_soon/stale |
| IRS | 日更新 | 盘后刷新 | fresh/stale_soon/stale |
| PAS | 日更新 | 盘后刷新 | fresh/stale_soon/stale |
| Integrated | 日更新 | 盘后刷新 | fresh/stale_soon/stale |
| Trading | 分钟级 | 60秒 | fresh/stale_soon/stale |
| Analysis | 日更新 | 盘后刷新 | fresh/stale_soon/stale |

### 6.2 刷新流程

```
┌─────────────────────────────────────────┐
│  定时刷新任务                            │
│                                          │
│  每60秒:                                 │
│    if page == Dashboard || Trading:     │
│        invalidate_cache(page_key)       │
│        fetch_new_data()                 │
│        update_ui()                      │
│                                          │
│  盘后(15:30后):                          │
│    for page in [MSS, IRS, PAS, ...]:    │
│        invalidate_all_caches()          │
│        prefetch_daily_data()            │
└─────────────────────────────────────────┘
```

---

## 7. 异常处理

### 7.1 数据缺失处理

| 场景 | 处理 | 用户提示 |
|------|------|----------|
| 数据未就绪 | 显示加载中 | "数据未就绪，请稍后刷新" |
| 接口超时 | 重试3次 | "请求超时，请重试" |
| 空结果 | 显示空状态 | "无符合条件的数据" |
| 数据降级 | 展示可用子集并标记 `warn_data_fallback` | "部分数据缺失，已降级展示" |
| 权限不足 | 隐藏操作 | "权限不足，请联系管理员" |

### 7.2 错误边界

```
┌─────────────────────────────────────────┐
│  ErrorBoundary                          │
│                                          │
│  try:                                    │
│      render_component()                 │
│  except DataNotReadyError:              │
│      show_loading_skeleton()            │
│  except TimeoutError:                   │
│      show_retry_button()                │
│      record_ui_event("timeout")         │
│  except PermissionError:                │
│      show_permission_denied()           │
│      record_ui_event("permission_denied")│
│  except Exception:                      │
│      show_generic_error()               │
│      log_error_to_console()             │
│      record_ui_event("unknown_error")   │
└─────────────────────────────────────────┘
```

### 7.3 异常观测面板（P1）

```
ui_observability_panel
  - timeout_count_1h
  - empty_state_count_1h
  - data_fallback_count_1h
  - permission_denied_count_1h
  - last_error_message
```

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.2.0 | 2026-02-14 | 闭环修订：新增 CP-09 最小闭环流程；Dashboard 流程补齐阈值解析与新鲜度展示；推荐流改为配置阈值并联动 Analysis 原因面板；异常处理补齐 `warn_data_fallback` 与事件计数，新增异常观测面板 |
| v3.1.6 | 2026-02-09 | 修复 R26：Dashboard/推荐列表流程补充 `integration_mode` 转换与 `integration_mode_badge` 展示，确保模式来源可视化追溯 |
| v3.1.5 | 2026-02-09 | 修复 R22：温度卡片示例将兜底分支显式化为 `<30 → blue`，避免与三段阈值误读 |
| v3.1.4 | 2026-02-08 | 修复 R16：温度卡片示例补全 `>=30→cyan` 与 `else→blue` 分支说明，避免误读为三段分级 |
| v3.1.3 | 2026-02-07 | 修复 R9：温度阈值示例同步 GUI 算法（30/45/80 分段）；ErrorBoundary 改为 `except Exception:` |
| v3.1.2 | 2026-02-07 | 同步 GUI 算法 v3.1.2 的推荐等级口径 |
| v3.1.0 | 2026-02-04 | 明确 Streamlit 正式 GUI、Jupyter 原型定位 |
| v3.0.0 | 2026-01-31 | 重构版：统一信息流描述 |
| v2.1.0 | 2026-01-23 | 增加缓存和刷新策略 |
| v2.0.0 | 2026-01-20 | 初始版本 |

---

**关联文档**：
- 核心算法：[gui-algorithm.md](./gui-algorithm.md)
- 数据模型：[gui-data-models.md](./gui-data-models.md)
- API接口：[gui-api.md](./gui-api.md)


