# Data Layer 信息流

**版本**: v3.1.4（重构版）
**最后更新**: 2026-02-14
**状态**: 设计修订完成（含质量门禁闭环信息流）

---

## 实现状态（仓库现状）

- 当前仓库 `src/data/` 仍以骨架为主，但已补充：
  - `src/data/models/snapshots.py` 质量字段契约（`data_quality/stale_days/source_trade_date`）
  - `src/data/quality_gate.py` 门禁决策流（ready/degraded/blocked）
- 本文档为设计信息流，后续实现按本流转落地。

---

## 1. 数据流总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Data Layer 信息流架构图                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  外部数据源                                                                  │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │                        TuShare API                                │       │
│  │  daily / daily_basic / limit_list_d / index_daily / index_member  │       │
│  │  index_classify / stock_basic / trade_cal                         │       │
│  └──────────────────────────┬───────────────────────────────────────┘       │
│                             │                                                │
│                             ▼                                                │
│  L1 原始数据层 (Parquet)                                                     │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  ${DATA_PATH}/parquet/                                           │       │
│  │  ├── daily/{trade_date}.parquet                                  │       │
│  │  ├── daily_basic/{trade_date}.parquet                            │       │
│  │  ├── limit_list/{trade_date}.parquet                             │       │
│  │  ├── index_daily/{trade_date}.parquet                            │       │
│  │  ├── index_member/index_member.parquet                           │       │
│  │  ├── index_classify/index_classify.parquet                       │       │
│  │  ├── stock_basic/stock_basic.parquet                             │       │
│  │  └── trade_cal/trade_cal.parquet                                 │       │
│  └──────────────────────────┬───────────────────────────────────────┘       │
│                             │                                                │
│                             ▼                                                │
│  L2 处理数据层 (DuckDB 单库优先，阈值触发分库)                                │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  market_snapshot    行业聚合     industry_snapshot                │       │
│  │  (涨跌家数统计)  ←───────────→  (31个行业)                         │       │
│  │                                                                   │       │
│  │  stock_gene_cache                                                │       │
│  │  (牛股基因缓存)                                                   │       │
│  └──────────────────────────┬───────────────────────────────────────┘       │
│                             │                                                │
│                             ▼                                                │
│  L3 算法输出层 (DuckDB 单库优先，阈值触发分库)                                │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  mss_panorama ──────→ irs_industry_daily ──────→ stock_pas_daily │       │
│  │  (市场情绪)           (行业评分)              (个股评分)          │       │
│  │                                    │                              │       │
│  │                                    ▼                              │       │
│  │                     integrated_recommendation                     │       │
│  │                         (三三制集成推荐)                          │       │
│  └──────────────────────────┬───────────────────────────────────────┘       │
│                             │                                                │
│                             ▼                                                │
│  L4 分析层 (DuckDB 单库优先，阈值触发分库)                                    │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  daily_report / performance_metrics / signal_attribution         │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│  Ops/Metadata（非L1-L4）                                                     │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  system_config / data_version_log / task_execution_log            │       │
│  │  data_quality_report                                             │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│                                                                              │
│                             ↓                                                │
│  下游消费者                                                                  │
│  ┌──────────────────────────────────────────────────────────────────┐       │
│  │  Trading Layer (交易执行) / GUI Layer (可视化) / Analysis Layer  │       │
│  └──────────────────────────────────────────────────────────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

缺口处理原则（本地数据优先）：
- 外部补采仅用于离线补全，必须先落库/缓存后进入主流程
- 主流程只读本地数据，禁止远端实时查询作为常态依赖
- 缺失时允许使用“上次可用数据”降级，但必须标记质量状态与来源
- 降级质量字段强制输出：`data_quality ∈ {normal, stale, cold_start}`、`stale_days >= 0`、`source_trade_date`
- 降级链上限：`stale_days > 3` 视为不可用，必须阻断算法主流程并触发告警

补充说明：`pas_breadth_daily` 由 `stock_pas_daily` 聚合生成（BU 模式入口），用于 Integration 的 Bottom-Up 流程。

---

## 2. 每日数据流水线

### 2.1 时序流程

```
Timeline: T日 15:30 收盘后

T+0min ─────────────────────────────────────────────────────────
  │
  │  ┌──────────────────────────────────────────────┐
  │  │  Step 1: 数据下载 (15:30-16:10)              │
  │  │                                               │
  │  │  TuShare API                                 │
  │  │     │                                        │
  │  │     ├── daily()         → daily.parquet     │
  │  │     ├── daily_basic()   → daily_basic.parquet│
  │  │     ├── limit_list_d()  → limit_list.parquet │
  │  │     └── index_daily()   → index_daily.parquet│
  │  │                                               │
  │  │  并发：4线程                                  │
  │  │  限流：120次/分钟                             │
  │  │  重试：3次指数退避                            │
  │  └──────────────────────────────────────────────┘
  │
T+40min ────────────────────────────────────────────────────────
  │
  │  ┌──────────────────────────────────────────────┐
  │  │  Step 2: 数据加工 (16:10-17:00)              │
  │  │                                               │
  │  │  Parquet Files                               │
  │  │     │                                        │
  │  │     ├─────────────────────┐                  │
  │  │     │  市场快照聚合       │                  │
  │  │     │  ├── 涨跌家数统计   │                  │
  │  │     │  ├── 涨跌停统计     │                  │
  │  │     │  ├── 100日新高/低   │                  │
  │  │     │  └── 昨涨停今表现   │                  │
  │  │     │         ↓           │                  │
  │  │     │  market_snapshot    │                  │
  │  │     │                     │                  │
  │  │     └─────────────────────┤                  │
  │  │                           │                  │
  │  │     ├─────────────────────┐                  │
  │  │     │  行业快照聚合(×31)  │                  │
  │  │     │  ├── index_member映射│                 │
  │  │     │  ├── 行业涨跌/新高/新低│                │
  │  │     │  ├── 行业涨跌停统计   │                 │
  │  │     │  ├── 行业涨跌幅(指数) │                 │
  │  │     │  ├── 行业成交/换手    │                 │
  │  │     │  └── 估值/Top5统计   │                 │
  │  │     │         ↓           │                  │
  │  │     │  industry_snapshot  │                  │
  │  │     │                     │                  │
  │  │     └─────────────────────┤                  │
  │  │                           │                  │
  │  │     ├─────────────────────┐                  │
  │  │     │  牛股基因更新       │                  │
  │  │     │  ├── 涨停历史       │                  │
  │  │     │  ├── 新高历史       │                  │
  │  │     │  └── 爆发力计算     │                  │
  │  │     │         ↓           │                  │
  │  │     │  stock_gene_cache   │                  │
  │  │     └─────────────────────┘                  │
  │  └──────────────────────────────────────────────┘
  │
T+90min ────────────────────────────────────────────────────────
  │
  │  ┌──────────────────────────────────────────────┐
  │  │  Step 3: 算法执行 (17:00-17:15)              │
  │  │                                               │
  │  │  market_snapshot                             │
  │  │     │                                        │
  │  │     ▼                                        │
  │  │  MSS Algorithm ─────→ mss_panorama          │
  │  │     │                 (temperature/cycle)    │
  │  │     │                                        │
  │  │  industry_snapshot                           │
  │  │     │                                        │
  │  │     ▼                                        │
  │  │  IRS Algorithm ─────→ irs_industry_daily    │
  │  │     │                 (score/rank/status)    │
  │  │     │                                        │
  │  │  stock_gene_cache + daily                    │
  │  │     │                                        │
  │  │     ▼                                        │
  │  │  PAS Algorithm ─────→ stock_pas_daily       │
  │  │                       (opportunity_score)    │
  │  └──────────────────────────────────────────────┘
  │
T+110min ───────────────────────────────────────────────────────
  │
  │  ┌──────────────────────────────────────────────┐
  │  │  Step 3.5: Validation Gate (17:15-17:20)     │
  │  │                                               │
  │  │  validation_gate_decision                     │
  │  │     ├── selected_weight_plan                  │
  │  │     └── gate_status(PASS/WARN/FAIL)           │
  │  └──────────────────────────────────────────────┘
  │
T+115min ───────────────────────────────────────────────────────
  │
  │  说明：评分与归一化（count→ratio→zscore）在算法层完成，数据层仅提供原始计数/聚合。
  │
  │  ┌──────────────────────────────────────────────┐
  │  │  Step 4: 集成与质量检查 (17:20-17:40)        │
  │  │                                               │
  │  mss_panorama + irs_industry_daily           │
  │       + stock_pas_daily (+ pas_breadth_daily)│
  │  │            │                                 │
  │  │            ▼                                 │
  │  │  Integration ────→ integrated_recommendation│
  │  │                    (final_score/recommendation)│
  │  │                                               │
  │  │  质量检查                                    │
  │  │     ├── 覆盖率检查 (≥95%)                    │
  │  │     ├── 空值率检查 (≤1%)                     │
  │  │     ├── 评分范围检查 (0-100)                 │
  │  │     └── 结果 → data_quality_report          │
  │  │                                               │
  │  │  元数据记录                                  │
  │  │     ├── data_version_log                    │
  │  │     └── task_execution_log                  │
  │  └──────────────────────────────────────────────┘
  │
T+130min ─────────────── 流水线完成 ────────────────────────────
```

### 2.2 stock_gene_cache 窗口滚动策略（PAS 对齐）

- `stock_gene_cache` 每个交易日滚动更新一次。
- `limit_up_count_120d`：使用最近 120 个交易日窗口滚动计算。
- `new_high_count_60d`：使用最近 60 个交易日窗口滚动计算。
- `max_pct_chg_history`：历史最大涨幅，只有当新值更高时更新。
- 当任一窗口依赖缺失并触发“沿用前值”时，必须同步写入：
  - `data_quality = stale`
  - `stale_days = trade_date - source_trade_date`
  - `source_trade_date = 最近有效快照日`

### 2.3 调度时间表（与算法文档对齐）

| 时间段 | 任务 | 说明 |
|--------|------|------|
| 15:30-16:10 | 拉取基础数据 | daily/daily_basic/limit_list |
| 16:10-16:20 | 拉取基准指数 | index_daily |
| 16:20-16:30 | 校验行业映射 | index_member/index_classify |
| 16:30-17:00 | 快照聚合 | market_snapshot/industry_snapshot/stock_gene_cache |
| 17:00-17:15 | 算法输出 | MSS/IRS/PAS |
| 17:15-17:20 | 验证门禁 | Validation Gate（权重选择） |
| 17:20-17:40 | 集成与质量检查 | integrated_recommendation + pas_breadth_daily + 质量报告 |
| 11:35 / 14:30（可选） | 盘中增量观测 | intraday_incremental_snapshot（不进入主交易链路） |

### 2.4 数据依赖关系

```
                    ┌─────────────┐
                    │  TuShare    │
                    │    API      │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │  daily   │    │  limit_  │    │  index_  │
    │ .parquet │    │  list    │    │  member  │
    └────┬─────┘    └────┬─────┘    └────┬─────┘
         │               │               │
         └───────────────┼───────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
  ┌────────────┐  ┌────────────┐  ┌────────────┐
  │  market_   │  │ industry_  │  │  stock_    │
  │  snapshot  │  │  snapshot  │  │ gene_cache │
  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘
        │               │               │
        ▼               ▼               │
  ┌──────────┐    ┌──────────┐         │
  │   MSS    │    │   IRS    │         │
  │ panorama │    │ industry │         │
  └────┬─────┘    └────┬─────┘         │
       │               │               │
       │               │       ┌───────┘
       │               │       │
       │               ▼       ▼
       │         ┌───────────────┐
       │         │  stock_pas_   │
       │         │     daily     │
       │         └───────┬───────┘
       │                 │
       └────────┬────────┘
                │
                ▼
        ┌───────────────┐
        │  integrated_  │
        │recommendation │
        └───────────────┘
```

---

## 3. 数据格式转换

### 3.1 TuShare → Parquet

```
输入 (TuShare DataFrame):
┌─────────────┬────────────┬────────┬────────┬─────────┐
│   ts_code   │ trade_date │  close │  vol   │ pct_chg │
├─────────────┼────────────┼────────┼────────┼─────────┤
│ 000001.SZ   │ 20260131   │ 15.23  │ 123456 │  2.35   │
│ 000002.SZ   │ 20260131   │ 22.45  │ 234567 │ -1.23   │
└─────────────┴────────────┴────────┴────────┴─────────┘

转换规则:
- 日期格式: YYYYMMDD (保持)
- 股票代码: 保留 ts_code 格式 (000001.SZ)
- 数值精度: float64

输出 (Parquet):
${DATA_PATH}/parquet/daily/20260131.parquet
- 压缩: snappy
- 分区: 按 trade_date
```

### 3.2 Parquet → DuckDB (L2)

```
输入 (Parquet daily + limit_list):
daily: N条记录
limit_list: M条记录

聚合计算:
total_stocks = COUNT(daily)
rise_count = COUNT(daily WHERE pct_chg > 0)
fall_count = COUNT(daily WHERE pct_chg < 0)
flat_count = COUNT(daily WHERE abs(pct_chg) <= 0.5)
limit_up_count = COUNT(limit_list WHERE limit = 'U')
...

输出 (DuckDB market_snapshot):
┌────────────┬──────────────┬────────────┬────────────┬───────────────┐
│ trade_date │ total_stocks │ rise_count │ fall_count │ limit_up_count│
├────────────┼──────────────┼────────────┼────────────┼───────────────┤
│ 20260131   │ 5234         │ 2876       │ 2103       │ 78            │
└────────────┴──────────────┴────────────┴────────────┴───────────────┘
```

### 3.3 L2 → L3 (算法输出)

```
输入 (market_snapshot):
{
  "trade_date": "20260131",
  "rise_count": 2876,
  "limit_up_count": 78,
  "new_100d_high_count": 156,
  ...
}

MSS算法处理:
1. 计算大盘系数: rise_count / total_stocks × 100
2. 计算赚钱效应: 涨停+新高权重组合
3. 计算亏钱效应: 跌停+新低权重组合
4. 合成温度: 三系数加权平均
5. 判断周期: 温度+趋势→周期状态机

输出 (mss_panorama):
┌────────────┬─────────────┬──────────────┬────────────┬──────────────┐
│ trade_date │ temperature │    cycle     │   trend    │position_advice│
├────────────┼─────────────┼──────────────┼────────────┼──────────────┤
│ 20260131   │ 65.3        │ divergence   │ up         │ 40%-60%      │
└────────────┴─────────────┴──────────────┴────────────┴──────────────┘
```

### 3.4 IRS 历史基准查询（跨年）

```python
# 显式传参，避免“默认参数隐式依赖”导致口径歧义
historical_stats = api.query_irs_historical_baseline(
    industry_code=industry_code,
    baseline_start='20150101',
    baseline_end='20251231'
)
```

---

## 4. 组件交互序列

### 4.1 正常流程

```
┌─────────┐ ┌──────────┐ ┌───────────┐ ┌──────────┐ ┌───────────┐
│Scheduler│ │DataFetcher│ │DataProcessor│ │Repository│ │Algorithm │
└────┬────┘ └────┬─────┘ └─────┬─────┘ └────┬─────┘ └─────┬─────┘
     │           │             │            │             │
     │ trigger() │             │            │             │
     │──────────>│             │            │             │
     │           │ fetch_all() │            │             │
     │           │────────────>│            │             │
     │           │             │            │             │
     │           │  raw data   │            │             │
     │           │<────────────│            │             │
     │           │             │            │             │
     │           │ process()   │            │             │
     │           │────────────>│            │             │
     │           │             │            │             │
     │           │             │ save()     │             │
     │           │             │───────────>│             │
     │           │             │            │             │
     │           │             │   ok       │             │
     │           │             │<───────────│             │
     │           │             │            │             │
     │           │ run_mss()   │            │             │
     │           │────────────────────────────────────────>│
     │           │             │            │             │
     │           │             │            │   query()   │
     │           │             │            │<────────────│
     │           │             │            │             │
     │           │             │            │    data     │
     │           │             │            │────────────>│
     │           │             │            │             │
     │           │             │            │   save()    │
     │           │             │            │<────────────│
     │           │             │            │             │
     │  done     │             │            │             │
     │<──────────│             │            │             │
```

### 4.2 失败重试流程

```
┌─────────┐ ┌──────────┐ ┌───────────┐
│Scheduler│ │DataFetcher│ │ErrorHandler│
└────┬────┘ └────┬─────┘ └─────┬─────┘
     │           │             │
     │ fetch()   │             │
     │──────────>│             │
     │           │ API Error   │
     │           │────────────>│
     │           │             │
     │           │ retry(1)    │
     │           │<────────────│
     │           │             │
     │           │ API Error   │
     │           │────────────>│
     │           │             │
     │           │ retry(2)    │
     │           │<────────────│
     │           │             │
     │           │ API Error   │
     │           │────────────>│
     │           │             │
     │           │ max_retries │
     │           │<────────────│
     │           │             │
     │  error    │             │
     │<──────────│             │
     │           │             │
     │ log_error │             │
     │──────────────────────────>│
```

---

## 5. 数据质量门禁

### 5.1 Step 0 门禁检查

```
┌───────────────────────────────────────────────────────────────┐
│                   Step 0 数据准备门禁                          │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  输入: trade_date = "20260131"                                │
│                                                                │
│  检查项:                                                       │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 1. 数据完整性检查                                        │  │
│  │    ├── daily.parquet 存在 ✓                             │  │
│  │    ├── limit_list.parquet 存在 ✓                        │  │
│  │    ├── daily_basic.parquet 存在 ✓                       │  │
│  │    ├── index_daily.parquet 存在 ✓                       │  │
│  │    ├── index_member.parquet 存在 ✓                      │  │
│  │    ├── index_classify.parquet 存在 ✓                    │  │
│  │    ├── stock_basic.parquet 存在 ✓                       │  │
│  │    └── trade_cal.parquet 存在 ✓                         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 2. 数据覆盖率检查                                        │  │
│  │    └── daily 股票数 / 上市股票数 >= 95%                 │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 3. 数据时效性检查                                        │  │
│  │    └── 数据日期 = 最近交易日                            │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 4. 数据一致性检查                                        │  │
│  │    └── daily.trade_date = limit_list.trade_date        │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  输出:                                                         │
│  - is_ready: true/false                                       │
│  - issues: []                                                 │
│                                                                │
│  流转条件:                                                     │
│  - is_ready = true → 继续执行 Step 2 数据加工                │
│  - is_ready = false → 触发回填或告警                         │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

### 5.2 输出验证门禁

```

补充门禁：
- 若 `market_snapshot.stale_days > 3` 或 `industry_snapshot.stale_days > 3`，则置 `is_ready=false`，阻断 MSS/IRS/PAS 并触发 P1 告警。
- 若 `data_quality in {stale, cold_start}` 且 `stale_days <= 3`，允许继续但必须透传质量标记到下游。
- 若核心输入存在多个 `source_trade_date`（跨日混用），则置 `status=blocked` 并阻断主流程。
┌───────────────────────────────────────────────────────────────┐
│                   输出验证门禁                                 │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  检查对象: mss_panorama / irs_industry_daily / stock_pas_daily│
│            integrated_recommendation / pas_breadth_daily      │
│                                                                │
│  检查项:                                                       │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 1. 评分范围检查                                          │  │
│  │    ├── temperature ∈ [0, 100]                           │  │
│  │    ├── industry_score ∈ [0, 100]                        │  │
│  │    ├── opportunity_score ∈ [0, 100]                     │  │
│  │    └── neutrality ∈ [0, 1]                              │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 2. 空值检查                                              │  │
│  │    └── 关键字段 NOT NULL                                │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 3. 记录数检查                                            │  │
│  │    ├── irs_industry_daily = 31 条                       │  │
│  │    ├── stock_pas_daily >= 1000 条                       │  │
│  │    └── pas_breadth_daily 有 market 级记录                │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 4. 逻辑一致性检查                                        │  │
│  │    ├── integrated 的 stock_code 存在于 pas_daily 中     │  │
│  │    └── integration_mode ∈ {top_down,bottom_up,dual_verify,complementary} │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

### 5.3 自动化门禁决策流（P0）

```python
from src.data.quality_gate import evaluate_data_quality_gate

decision = evaluate_data_quality_gate(
    trade_date=trade_date,
    coverage_ratio=coverage_ratio,
    source_trade_dates=source_trade_dates,      # e.g. {"daily":"20260214","limit_list":"20260214"}
    quality_by_dataset=quality_by_dataset,      # e.g. {"daily":"normal","limit_list":"normal"}
    stale_days_by_dataset=stale_days_by_dataset # e.g. {"daily":0,"limit_list":0}
)

if decision.status == "blocked":
    # 触发告警并停止 MSS/IRS/PAS
    block_pipeline(decision.issues)
elif decision.status == "degraded":
    # 允许继续，但强制透传质量标记到 L2/L3/L4
    run_pipeline_with_quality_flags(decision.warnings)
else:
    run_pipeline()
```

---

## 6. 异常处理流程

### 6.1 数据缺失处理

```
检测到数据缺失
     │
     ▼
┌─────────────┐
│ 检查缺失类型│
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
 L1缺失   L2/L3缺失
   │       │
   ▼       ▼
回填API  重新计算
   │       │
   ▼       ▼
验证成功? 验证成功?
   │       │
   │       │
   ├───────┼───── 是 ──→ 继续流水线
   │       │
   └───────┴───── 否 ──→ 门禁判定（degraded 或 blocked）并记录 stale_days/source_trade_date
```

### 6.2 计算异常处理

```
检测到计算异常
     │
     ▼
┌─────────────────┐
│ 异常类型判断     │
└───────┬─────────┘
        │
    ┌───┴───┬───────────┐
    │       │           │
    ▼       ▼           ▼
  超界    除零        NaN
    │       │           │
    ▼       ▼           ▼
 clip(0,100) 返回50  forward_fill
    │       │           │
    └───────┴───────────┘
            │
            ▼
      标记 degraded
            │
            ▼
        继续执行
```

---

## 7. 数据备份与恢复

### 7.1 备份流程

```
每日 22:00
     │
     ▼
┌─────────────────────┐
│ 备份 DuckDB 数据库   │
│ → backups/duckdb/ │
│   emotionquant_   │
│   {YYYY}.duckdb   │
└─────────┬───────────┘
         │
         ▼
┌──────────────────┐
│ 备份 Parquet 数据 │
│ → backups/       │
│   parquet_       │
│   {YYYYMMDD}.tar │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 清理30天前备份   │
└──────────────────┘
```

### 7.2 恢复流程

```
恢复请求
     │
     ├── 指定日期: YYYYMMDD
     │
     ▼
┌──────────────────┐
│ 停止写入服务     │
└────────┬─────────┘
         │
         ▼
┌─────────────────────┐
│ 恢复 DuckDB        │
│ backups/duckdb/   │
│ emotionquant_     │
│ {YYYY}.duckdb     │
└─────────┬───────────┘
         │
         ▼
┌──────────────────┐
│ 恢复 Parquet     │
│ backups/{date}.tar│
│ → parquet/       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 一致性验证       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 重启服务         │
└──────────────────┘
```

### 7.3 分库触发与回迁流程（P2）

```
日终容量与性能评估
     │
     ├── db_size_gb > 120
     ├── query_p95_sec > 2.0（连续5日）
     └── daily_rows > 3000万
     │
     ▼
┌──────────────────┐
│ 触发年度分库     │
│ emotionquant_YYYY│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 跨库一致性校验   │
│ 行数/校验和/抽样 │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ query_cross_year │
│ 透明聚合读取     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 回迁评估（90日） │
│ p95 < 1.0 可回迁 │
└──────────────────┘
```

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.1.4 | 2026-02-14 | 修复 R32（review-010）：实现状态补充已落地门禁原型；时序新增可选盘中增量观测；门禁补充跨日一致性阻断；新增自动化门禁决策流与分库触发/回迁流程 |
| v3.1.3 | 2026-02-09 | 修复 R31：§3.3 示例口径纠偏（`temperature=65.3` 时 `cycle=divergence`；`position_advice` 由 `70%` 更正为 `40%-60%`） |
| v3.1.2 | 2026-02-09 | 修复 R26：缺口降级补齐 `data_quality/stale_days/source_trade_date` 契约与 `stale_days>3` 阻断规则；新增 `stock_gene_cache` 120/60 日窗口滚动策略说明 |
| v3.1.1 | 2026-02-09 | 修复 R23：时间轴补充 `Validation Gate (17:15-17:20)` 并新增调度时间表；补充 IRS 历史基准查询显式传参示例 |
| v3.1.0 | 2026-02-04 | 对齐 MSS/IRS/PAS/Integration：补充 PAS 广度派生与门禁校验项 |
| v3.0.0 | 2026-01-31 | 重构版：统一数据流、门禁检查 |

---

**关联文档**：
- 数据管线设计：[data-layer-algorithm.md](./data-layer-algorithm.md)
- 数据模型：[data-layer-data-models.md](./data-layer-data-models.md)
- API接口：[data-layer-api.md](./data-layer-api.md)


