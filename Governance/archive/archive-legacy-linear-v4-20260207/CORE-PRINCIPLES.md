# EmotionQuant 核心原则（重构版）

**版本**: v3.3.0
**创建日期**: 2026-01-31
**最后更新**: 2026-02-05
**状态**: 与重构设计文档对齐

---

## 文档对齐声明

> 本核心原则与 `docs/` 下的设计文档保持严格一致。
>
> **权威设计文档**：
> - 系统总览：`docs/system-overview.md`
> - 模块索引：`docs/module-index.md`
> - 核心算法：`docs/design/core-algorithms/`

---

## 治理结构约定

> 治理目录、报告与归档规范见 `Governance/steering/GOVERNANCE-STRUCTURE.md`，必须遵循。

---

## 1. 系统铁律（摘要）

> 本节仅提供一致性摘要，详细条款与示例见
> `Governance/steering/系统铁律.md`（权威细则）。

### 1.1 零技术指标（最严格）

- **定义**：禁止任何传统技术指标作为信号/特征来源  
- **允许**：原始 OHLCV、涨跌幅（直接计算）、涨跌停统计、市场广度  
- **检查**：pre-commit + 代码审查  
- **详见**：系统铁律

### 1.2 情绪优先

- 所有分析必须基于情绪因子（市场广度、涨跌停、资金流向、波动特征等）  
- 设计评审必须说明情绪因子来源
- MSS / IRS / PAS 三算法同权协同，集成层不得以单算法硬否决

### 1.3 本地数据优先

- 系统运行优先使用本地数据库与本地存储数据
- 外部数据源仅用于离线更新或补充，缺口补采必须先落库/缓存
- 数据路径通过环境变量或配置注入
- 允许使用“上次可用数据”降级，但必须标记质量状态与来源

### 1.4 路径硬编码绝对禁止

- 路径/密钥/配置必须通过环境变量或配置注入
- 禁止硬编码绝对/相对路径与敏感信息

### 1.5 A 股专属

- 系统仅支持中国 A 股市场（上交所、深交所）
- 交易/回测必须遵守 T+1、涨跌停、申万 31 行业等规则

---

## 2. 命名约定

### 2.1 周期命名

| 英文 | 中文 | 温度区间 | 仓位建议 |
|------|------|----------|----------|
| emergence | 萌芽期 | <30 | 80%-100% |
| fermentation | 发酵期 | 30-45 | 60%-80% |
| acceleration | 加速期 | 45-60 | 50%-70% |
| divergence | 分歧期 | 60-75 | 40%-60% |
| climax | 高潮期 | ≥75 | 20%-40% |
| diffusion | 扩散期 | 60-75 | 30%-50% |
| recession | 退潮期 | <60 | 0%-20% |

**强制要求**: 代码中使用英文，注释/文档/UI使用中文

### 2.2 趋势命名

| 英文 | 中文 | 判断条件 |
|------|------|----------|
| up | 上行 | 温度/价格连续N日上升 |
| down | 下行 | 温度/价格连续N日下降 |
| sideways | 横盘 | 温度/价格在区间内震荡 |

### 2.3 轮动状态

| 状态 | 描述 | 触发条件 |
|------|------|----------|
| IN | 进入轮动 | 评分连续3日上升 |
| OUT | 退出轮动 | 评分连续3日下降 |
| HOLD | 维持观望 | 其他情况 |

---

## 3. 数据架构约定

### 3.1 四层架构

| 层级 | 名称 | 数据特征 | 存储格式 |
|------|------|----------|----------|
| L1 | 原始数据层 | 外部采集，不做计算 | Parquet |
| L2 | 特征层 | 从L1计算情绪因子 | DuckDB（按年分库） |
| L3 | 算法输出层 | MSS/IRS/PAS输出 | DuckDB（按年分库） |
| L4 | 分析层 | 绩效/报告 | DuckDB（按年分库） + Markdown |

### 3.2 数据依赖规则

- L2 只能读取 L1
- L3 只能读取 L1, L2
- L4 只能读取 L1, L2, L3
- 禁止反向依赖

---

## 4. 代码规范

### 4.1 路径管理

**禁止**:
```python
# ❌ 硬编码路径
db_path = "data/emotionquant.db"
cache_dir = "G:/EmotionQuant_data/"
```

**必须**:
```python
# ✅ 使用配置
from src.config.config import Config
config = Config.from_env()
duckdb_dir = config.duckdb_dir
```

### 4.2 分支策略

```
feature/phase-XX-task-Y
    ↓ (测试通过)
develop
    ↓ (里程碑)
main/master
```

**禁止**:
- 直接在 main 上开发
- feature 直接合并到 main
- 未测试就合并

### 4.3 TDD要求

**分级覆盖率要求**：

| 模块类型 | 覆盖率要求 | 说明 |
|----------|------------|------|
| 核心算法（MSS/IRS/PAS/Integration） | ≥ 80% | 严格要求 |
| 数据层（Repository） | ≥ 70% | 标准要求 |
| 回测/交易 | ≥ 70% | 标准要求 |
| GUI | ≥ 50% | 降低要求（难以单元测试） |
| 工具类 | ≥ 60% | 适度要求 |

**基本原则**：
- 先写测试后写实现
- 每个公共方法必须有测试
- 追求有价值的测试，而非数字

---

## 5. 质量门控

### 5.1 门控分级

| 门控类型 | 触发时机 | 说明 |
|----------|----------|------|
| **零容忍** | pre-commit + 合并前 | 必须通过，否则阻断 |
| **警告** | pre-commit | 提示但不阻断，合并前必须清理 |
| **建议** | 代码审查 | 可延后处理 |

### 5.2 TODO/HACK/FIXME 规则（重要调整）

> **新规则**：开发中允许，合并前清理

| 阶段 | TODO/HACK/FIXME 处理 |
|------|----------------------|
| 开发中 | ✅ 允许使用 |
| 提交 feature 分支 | ✅ 允许存在 |
| 合并到 develop | ❌ **必须清理** |
| A6 检查 | 扫描确认无残留 |

**处理方式**：
- 解决后删除标记
- 无法解决则登记到 `debts.md` 后删除标记

### 5.3 复用率规则（重要调整）

> **新规则**：删除 ≥30% 硬性指标，改为显式记录

**原因**：复用率可能被凑数，指标失真

**新要求**：
- 在 `final.md` 中显式记录复用了哪些资产
- 说明复用的价值（节省时间、降低风险等）
- 不做数字考核

### 5.4 6A工作流

| 阶段 | 名称 | 检查项 |
|------|------|--------|
| A1 | Align | 分支准备、需求对齐 |
| A2 | Architect | 设计评审、规范对齐 |
| A3 | Atomize | Step 拆分、依赖清晰 |
| A4 | Approve | 质量门控、用户/自检批准 |
| A5 | Automate | TDD 实现、覆盖率分级 |
| A6 | Assess | 收口评估、自检确认 |

### 5.5 验收标准

| 阶段 | 必须通过 |
|------|----------|
| A4 | pre-commit hook（警告） |
| A5 | pytest 覆盖率报告（分级） |
| A6 | 自检确认 + TODO清理 |

---

## 6. 违规处理

### 6.1 零容忍项（必须阻断）

| 违规类型 | 严重等级 | 处理方式 |
|----------|----------|----------|
| 使用技术指标 | 最严重 | 立即阻断，代码回滚 |
| 硬编码路径 | 严重 | 阻断，必须修正 |
| 绕过本地数据 | 严重 | 阻断，必须修正 |
| 违反 A 股规则 | 严重 | 阻断，必须修正 |

### 6.2 警告项（合并前处理）

| 违规类型 | 严重等级 | 处理方式 |
|----------|----------|----------|
| TODO/HACK/FIXME 残留 | 中等 | 合并前清理或登记债务 |
| TDD覆盖率不足 | 中等 | 按分级要求补充 |
| 命名不规范 | 轻微 | 下次修正 |

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.3.0 | 2026-02-05 | 更新系统铁律摘要：新增路径硬编码禁令与 A 股专属 |
| v3.2.0 | 2026-02-05 | 系统铁律更新：新增本地数据优先，移除铁律三/四摘要 |
| v3.1.3 | 2026-02-04 | 系统铁律摘要化，术语与 6A 对齐 |
| v3.1.2 | 2026-02-03 | 补充 BU 仅可作为 TD 框架下的补充信号说明 |
| v3.1.1 | 2026-02-03 | 数据层存储格式更新为 DuckDB（按年分库） |
| v3.1.0 | 2026-02-03 | **门控分级优化**：TDD覆盖率分级，TODO规则改为合并前清理，复用率改为显式记录 |
| v3.0.0 | 2026-01-31 | 重构版：与 docs/ 设计文档对齐 |
| v1.0.0 | 2026-01-23 | 初始版本 |

---

**关联文档**：
- ROADMAP总览：`Governance/SpiralRoadmap/planA/VORTEX-EVOLUTION-ROADMAP.md`
- 系统总览：`docs/system-overview.md`


